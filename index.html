<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<style>
  /* Reset */
  *, *::before, *::after { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1a202c;
    color: #eee;
  }
  
  /* Header con profilo utente e icone circolari */
  .user-profile-section {
    position: fixed;
    top: 0;
    right: 0;
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 25px;
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    border-bottom-left-radius: 15px;
  }
  
  .user-circle {
    width: 45px;
    height: 45px;
    background: #4A90E2;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(74, 144, 226, 0.3);
  }
  
  .user-circle:hover {
    background: #357ABD;
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(74, 144, 226, 0.5);
  }
  
  .action-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    outline: none;
  }
  
  .action-circle:hover {
    transform: scale(1.1);
  }
  
  .settings-circle {
    background: #28a745;
    box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
  }
  
  .settings-circle:hover {
    background: #218838;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.5);
  }
  
  .logout-circle {
    background: #dc3545;
    box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
  }
  
  .logout-circle:hover {
    background: #c82333;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
  }
  
  /* Icone SVG */
  .icon-gear {
    width: 20px;
    height: 20px;
    fill: white;
  }
  
  .icon-logout {
    width: 18px;
    height: 18px;
    fill: white;
  }
  
  /* Login section */
  #login-section {
  position: fixed;
  inset: 0;
  background: #1a202c;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#login-form-container {
  background: #2d3748;
  padding: 2.5rem 3rem;
  border-radius: 1.4rem;
  min-width: 350px;
  text-align: center;
  box-shadow: 0 6px 32px rgba(0,0,0,0.38);
}

#login-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

#login-form input {
  width: 100%;
  padding: 0.7rem;
  border-radius: 6px;
  border: none;
  background: #222938;
  color: #eee;
}

#login-form button {
  width: 100%;
  padding: 0.88rem;
  background: #63b3ed;
  border: none;
  border-radius: 6px;
  color: white;
  font-weight: 700;
  font-size: 1.1rem;
  cursor: pointer;
}

#login-error {
  color: #f56565;
  margin-top: 1rem;
}
  
  /* Dashboard */
  #app {
    display: none;
    height: 100vh;
    opacity: 0;
    transition: opacity 0.7s ease;
    background: #f4f7fa;
    color: #222938;
    padding-top: 80px;
  }
  #app.visible {
    display: flex;
    opacity: 1;
  }
  nav.sidebar {
    width: 240px;
    background: #1a202c;
    color: #edf2f7;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  nav.sidebar .logo {
    padding: 24px 0;
    font-weight: 700;
    font-size: 1.5rem;
    text-align: center;
    border-bottom: 1px solid #2c3545;
    user-select: none;
  }
  nav.sidebar button {
    background: none;
    border: none;
    padding: 16px 24px;
    text-align: left;
    color: #a0aec0;
    font-weight: 600;
    font-size: 1.05rem;
    cursor: pointer;
    width: 100%;
    transition: background 0.3s ease, border-left 0.3s ease, color 0.3s ease;
    border-left: 4px solid transparent;
  }
  nav.sidebar button:hover,
  nav.sidebar button.active {
    background-color: #2c3545;
    color: #63b3ed;
    border-left-color: #3182ce;
  }
  
  main.content {
    flex-grow: 1;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  main.content header {
    background: white;
    padding: 16px 24px;
    font-size: 1.25rem;
    font-weight: 600;
    box-shadow: 0 1px 4px rgba(0,0,0,0.10);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  main.content section {
    flex-grow: 1;
    position: absolute;
    top: 56px;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 32px;
    box-sizing: border-box;
    opacity: 0;
    transform: translateX(40px);
    transition: transform 0.4s ease, opacity 0.4s ease;
    display: none;
    overflow-y: auto;
  }
  main.content section.active {
    opacity: 1;
    transform: translateX(0);
    display: block;
    position: relative;
  }
  
  /* Stats cards */
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-5px);
  }
  .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .stat-label {
    font-size: 1rem;
    opacity: 0.9;
  }
  
  /* Table styles */
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 16px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.05);
    background: white;
    overflow: hidden;
  }
  th, td {
    padding: 12px 16px;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
  }
  th {
    background: #ebf8ff;
    color: #2b6cb0;
    font-weight: 700;
  }
  tr:hover td {
    background: #e2e8f0;
    transition: background-color 0.25s ease;
  }
  
  /* Buttons */
  button {
    cursor: pointer;
    border-radius: 6px;
    padding: 10px 18px;
    font-size: 0.95rem;
    font-weight: 600;
    border: none;
    transition: background-color 0.3s ease, transform 0.15s ease;
  }
  button:hover:not(.action-circle) {
    transform: scale(1.05);
  }
  button.primary {
    background-color: #3182ce;
    color: white;
  }
  button.primary:hover {
    background-color: #2563a9;
  }
  button.danger {
    background-color: #e53e3e;
    color: white;
  }
  button.danger:hover {
    background-color: #a81f1f;
  }
  .actions button {
    margin-right: 10px;
  }
  
  /* Forms */
  form {
    max-width: 640px;
    margin-top: 24px;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: opacity 0.5s ease, max-height 0.5s ease;
    display: none;
  }
  form.show {
    opacity: 1;
    max-height: 1200px;
    overflow: visible;
    display: block;
  }
  form div {
    margin-bottom: 18px;
  }
  label {
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
  }
  input[type="text"], select, input[type="date"], input[type="number"] {
    width: 100%;
    padding: 10px 12px;
    font-size: 1rem;
    border: 1px solid #cbd5e0;
    border-radius: 6px;
    background-color: #f7fafc;
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }
  input[type="text"]:focus, select:focus, input[type="date"]:focus, input[type="number"]:focus {
    border-color: #63b3ed;
    box-shadow: 0 0 8px #63b3ed99;
  }
  
  /* Responsive */
  @media(max-width: 768px) {
    .user-profile-section {
      position: relative;
      justify-content: center;
      padding: 10px;
    }
    #app {
      padding-top: 70px;
    }
    nav.sidebar {
      width: 70px;
    }
    nav.sidebar .logo {
      font-size: 1rem;
      padding: 16px 0;
    }
    nav.sidebar button {
      padding: 12px 12px;
      font-size: 0;
      position: relative;
    }
    nav.sidebar button::after {
      content: attr(data-tooltip);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      background-color: #2c3749;
      color: #edf2f7;
      padding: 6px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      margin-left: 10px;
      font-size: 14px;
      z-index: 20;
    }
    nav.sidebar button:hover::after {
      opacity: 1;
    }
    main.content section {
      position: relative;
      top: auto; bottom: auto; left: auto; right: auto;
      padding: 16px;
      overflow-y: visible;
    }
  }

  /* NOTIFICHE */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 8px;
  color: white;
  font-weight: 500;
  z-index: 1000;
  animation: slideIn 0.3s ease;
}

.notification-error {
  background: #dc3545;
}

.notification-success {
  background: #28a745;
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.fade-out {
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* Aggiungi nella sezione <style> */
.discord-login {
  margin-top: 2rem;
}

.discord-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 12px;
  background: #5865F2;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.3s ease;
}

.discord-btn:hover {
  background: #4752C4;
}

.discord-icon {
  width: 24px;
  height: 24px;
  fill: currentColor;
}
</style>
</head>
<body>

<!-- Login Section -->
<div id="login-section" role="dialog" aria-modal="true" aria-labelledby="login-title">
  <div id="login-form-container">
    <h2 id="login-title">Accesso Gestione UOPI</h2>
    <div class="discord-login">
      <button onclick="loginWithDiscord()" class="discord-btn">
        <svg class="discord-icon" viewBox="0 0 24 24">
          <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189Z"/>
        </svg>
        Accedi con Discord
      </button>
    </div>
  </div>
</div>

<!-- User Profile Header (visibile solo dopo login) -->
<div class="user-profile-section" id="user-header" style="display: none;">
  <!-- Cerchio con iniziali utente -->
  <div class="user-circle" title="Admin UOPI">
    A
  </div>
  
  <!-- Cerchio impostazioni -->
  <button class="action-circle settings-circle" title="Impostazioni" onclick="openSettings()">
    <svg class="icon-gear" viewBox="0 0 24 24">
      <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z" />
    </svg>
  </button>
  
  <!-- Cerchio logout -->
  <button class="action-circle logout-circle" title="Logout" onclick="confirmLogout()">
    <svg class="icon-logout" viewBox="0 0 24 24">
      <path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14C14.25,2 14.46,2.18 14.5,2.42L14.87,5.07C15.5,5.32 16.04,5.66 16.56,6.05L19.05,5.05C19.27,4.96 19.54,5.05 19.66,5.27L21.66,8.73C21.78,8.95 21.73,9.22 21.54,9.37L19.43,12.97Z" />
    </svg>
  </button>
</div>

<!-- Dashboard -->
<div id="app" aria-label="Dashboard UOPI" role="application" tabindex="0" aria-hidden="true">
  <nav class="sidebar" role="navigation" aria-label="Menu di navigazione">
    <div class="logo" aria-label="Logo UOPI FiveM">UOPI FiveM</div>
    <button class="active" data-section="operatori" data-tooltip="Operatori">☰ Operatori</button>
    <button data-section="interventi" data-tooltip="Interventi">🚨 Interventi</button>
    <button data-section="formazione" data-tooltip="Formazione">🎓 Formazione</button>
    <button data-section="equipaggiamenti" data-tooltip="Equipaggiamenti">🛡️ Equipaggiamenti</button>
    <button data-section="report" data-tooltip="Report">📊 Report</button>
  </nav>
  <main class="content" role="main">

    <header>Dashboard Gestione Operatori UOPI</header>

    <section id="operatori" class="active" tabindex="0" aria-label="Sezione Gestione Operatori">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-number" id="operatori-count">3</div>
          <div class="stat-label">Operatori in Servizio</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="interventi-count">1</div>
          <div class="stat-label">Operazioni Attive</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">2</div>
          <div class="stat-label">Squadre Operative</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">5</div>
          <div class="stat-label">Turni Pianificati</div>
        </div>
      </div>
      
      <h2>Operatori UOPI</h2>
      <button id="btn-add-operatore" class="primary" aria-controls="form-operatore">Aggiungi Operatore</button>
      <table aria-describedby="operatori-thead" role="grid">
        <thead id="operatori-thead">
          <tr>
            <th scope="col">Nome</th>
            <th scope="col">Grado</th>
            <th scope="col">Ruolo</th>
            <th scope="col">Stato Operativo</th>
            <th scope="col">Azioni</th>
          </tr>
        </thead>
        <tbody id="operatori-tbody"></tbody>
      </table>
      <form id="form-operatore" aria-labelledby="form-title" novalidate>
        <h3 id="form-title">Aggiungi Nuovo Operatore</h3>
        <div>
          <label for="op-nome">Nome Completo:</label>
          <input type="text" id="op-nome" required />
        </div>
        <div>
          <label for="op-grado">Grado:</label>
          <select id="op-grado" required>
            <option value="" disabled selected>Seleziona grado</option>
            <option>Agente</option>
            <option>Assistente</option>
            <option>Sovrintendente</option>
            <option>Ispettore</option>
            <option>Sostituto Commissario</option>
          </select>
        </div>
        <div>
          <label for="op-ruolo">Ruolo:</label>
          <input type="text" id="op-ruolo" required />
        </div>
        <div>
          <label for="op-stato">Stato Operativo:</label>
          <select id="op-stato" required>
            <option>Disponibile</option>
            <option>In Missione</option>
            <option>Non Disponibile</option>
          </select>
        </div>
        <button type="submit" class="primary">Salva</button>
        <button type="button" id="op-cancel-btn">Annulla</button>
      </form>
    </section>

    <section id="interventi" tabindex="0" aria-label="Sezione Gestione Interventi">
      <h2>Gestione Interventi</h2>
      <button id="btn-add-intervento" class="primary">Nuovo Intervento</button>
      <table>
        <thead>
          <tr>
            <th>ID Intervento</th>
            <th>Descrizione</th>
            <th>Assegnato a</th>
            <th>Stato</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="interventi-tbody"></tbody>
      </table>
      <form id="form-intervento" novalidate>
        <h3>Nuovo Intervento</h3>
        <div>
          <label for="int-desc">Descrizione:</label>
          <input type="text" id="int-desc" required />
        </div>
        <div>
          <label for="int-assegnato">Assegnato a (Nome Operatore):</label>
          <input type="text" id="int-assegnato" required list="operatori-list" />
          <datalist id="operatori-list"></datalist>
        </div>
        <div>
          <label for="int-stato">Stato:</label>
          <select id="int-stato" required>
            <option>In Attesa</option>
            <option>In Corso</option>
            <option>Completato</option>
          </select>
        </div>
        <button type="submit" class="primary">Salva Intervento</button>
        <button type="button" id="int-cancel-btn">Annulla</button>
      </form>
    </section>

    <section id="formazione" tabindex="0" aria-label="Sezione Gestione Formazione">
      <h2>Formazione e Certificazioni</h2>
      <button id="btn-add-istruzione" class="primary">Aggiungi Certificazione</button>
      <table>
        <thead>
          <tr>
            <th>Operatore</th>
            <th>Certificazione</th>
            <th>Data conseguimento</th>
            <th>Data scadenza</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="formazione-tbody"></tbody>
      </table>
      <form id="form-istruzione" novalidate>
        <h3>Aggiungi Certificazione</h3>
        <div>
          <label for="cert-op">Operatore (Nome):</label>
          <input type="text" id="cert-op" required list="operatori-list" />
        </div>
        <div>
          <label for="cert-nome">Certificazione:</label>
          <input type="text" id="cert-nome" required />
        </div>
        <div>
          <label for="cert-data">Data conseguimento:</label>
          <input type="date" id="cert-data" required />
        </div>
        <div>
          <label for="cert-scadenza">Data scadenza:</label>
          <input type="date" id="cert-scadenza" required />
        </div>
        <button type="submit" class="primary">Salva Certificazione</button>
        <button type="button" id="cert-cancel-btn">Annulla</button>
      </form>
    </section>

    <section id="equipaggiamenti" tabindex="0" aria-label="Sezione Gestione Equipaggiamenti">
      <h2>Equipaggiamenti</h2>
      <button id="btn-add-equip" class="primary">Aggiungi Equipaggiamento</button>
      <table>
        <thead>
          <tr>
            <th>Operatore</th>
            <th>Equipaggiamento</th>
            <th>Quantità</th>
            <th>Azioni</th>
          </tr>
        </thead>
        <tbody id="equipaggiamenti-tbody"></tbody>
      </table>
      <form id="form-equip" novalidate>
        <h3>Aggiungi Equipaggiamento</h3>
        <div>
          <label for="equip-op">Operatore (Nome):</label>
          <input type="text" id="equip-op" required list="operatori-list" />
        </div>
        <div>
          <label for="equip-nome">Equipaggiamento:</label>
          <input type="text" id="equip-nome" required />
        </div>
        <div>
          <label for="equip-qty">Quantità:</label>
          <input type="number" id="equip-qty" min="1" required />
        </div>
        <button type="submit" class="primary">Salva Equipaggiamento</button>
        <button type="button" id="equip-cancel-btn">Annulla</button>
      </form>
    </section>

    <section id="report" tabindex="0" aria-label="Sezione Report">
      <h2>Report e Analisi</h2>
      <button id="btn-export-csv" class="primary">Esporta Report Operatori</button>
      <pre id="report-output" style="background:#eee; padding:1rem; max-height:300px; overflow:auto; white-space: pre-wrap; color:#333;"></pre>
    </section>

  </main>
</div>

<script>
const DISCORD_CLIENT_ID = '1387801645743869982'; // Sostituisci con il tuo client ID
const REDIRECT_URI = window.location.origin + '/uopi_dashboard.html';

// Funzione per il login con Discord
function loginWithDiscord() {
  const params = new URLSearchParams({
    client_id: DISCORD_CLIENT_ID,
    redirect_uri: REDIRECT_URI,
    response_type: 'token',
    scope: 'identify'
  });
  
  window.location.href = `https://discord.com/api/oauth2/authorize?${params}`
}

// Gestione callback Discord
function handleDiscordCallback() {
  const fragment = new URLSearchParams(window.location.hash.slice(1));
  const accessToken = fragment.get('access_token');
  
  if (accessToken) {
    // Salva il token
    sessionStorage.setItem('discord_token', accessToken);
    // Ottieni info utente
    fetchDiscordUser(accessToken);
  }
}

// Ottieni info utente Discord
async function fetchDiscordUser(token) {
  try {
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });
    
    const user = await response.json();
    
    if (user.id) {
      // Verifica se l'utente è autorizzato (modifica con i tuoi ID)
      const allowedUsers = ['1387684968536477756', '817121576217870348']; // ID Discord degli admin
      
      if (allowedUsers.includes(user.id)) {
        sessionStorage.setItem('user_data', JSON.stringify(user));
        handleSuccessfulLogin();
      } else {
        notifications.error('Non sei autorizzato ad accedere');
      }
    }
  } catch (err) {
    notifications.error('Errore durante l\'autenticazione Discord');
    console.error(err);
  }
}

// Login gestione - CREDENZIALI: admin / admin
const loginHandler = {
  // Credenziali criptate (non usare in produzione)
  credentials: {
    username: 'admin',
    // Password hash per "admin"
    passwordHash: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'
  },

  init() {
    const form = document.getElementById('login-form');
    const error = document.getElementById('login-error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = form.username.value.trim();
      const password = form.password.value.trim();

      try {
        const hashedPassword = await this.hashPassword(password);
        
        if (username === this.credentials.username && 
            hashedPassword === this.credentials.passwordHash) {
          
          error.style.display = 'none';
          this.handleSuccessfulLogin();
          
        } else {
          error.style.display = 'block';
          error.textContent = 'Credenziali non valide!';
        }
      } catch (err) {
        error.style.display = 'block';
        error.textContent = 'Errore durante il login';
        console.error('Login error:', err);
      }
    });
  },

  async hashPassword(password) {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');
  },

  handleSuccessfulLogin() {
    const loginSection = document.getElementById('login-section');
    const app = document.getElementById('app');
    const userHeader = document.getElementById('user-header');

    loginSection.classList.add('fade-out');
    setTimeout(() => {
      loginSection.style.display = 'none';
      app.style.display = 'flex';
      app.classList.add('visible');
      userHeader.style.display = 'flex';
      
      // Salva sessione
      sessionStorage.setItem('logged_in', 'true');
      
      // Inizializza dashboard
      initDashboard();
      
      // Mostra notifica
      notifications.success('Login effettuato con successo');
    }, 600);
  }
};

  // Controllo sessione
(function checkSession() {
  if (sessionStorage.getItem('logged_in') === 'true') {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('app').classList.add('visible');
    document.getElementById('user-header').style.display = 'flex';
    initDashboard();
  }
})();

  const loginSection = document.getElementById('login-section');
  const loginForm = document.getElementById('login-form');
  const loginError = document.getElementById('login-error');
  const app = document.getElementById('app');
  const userHeader = document.getElementById('user-header');

  loginForm.addEventListener('submit', e => {
    e.preventDefault();
    const username = loginForm.username.value.trim();
    const password = loginForm.password.value.trim();

    // CREDENZIALI PREDEFINITE: admin / admin
    if (username === 'admin' && password === 'admin') {
      loginError.style.display = 'none';
      loginSection.classList.add('fade-out');
      setTimeout(() => {
        loginSection.style.display = 'none';
        app.style.display = 'flex';
        app.classList.add('visible');
        userHeader.style.display = 'flex';
        initDashboard();
      }, 600);
    } else {
      loginError.style.display = 'block';
    }
  });

  // Funzioni per le icone header
  function openSettings() {
    alert('Pannello Impostazioni\n\nFunzionalità disponibili:\n• Configurazione sistema\n• Gestione utenti\n• Impostazioni sicurezza\n• Backup database\n\n[In sviluppo...]');
  }

  function confirmLogout() {
    if (confirm('Sei sicuro di voler uscire dalla dashboard?\n\nPerderai tutti i dati non salvati.')) {
      sessionStorage.removeItem('logged_in');
      notifications.success('Logout effettuato con successo');
      setTimeout(() => location.reload(), 1000);
    }
  }

  let currentSectionId = 'operatori';

  function changeSection(newId) {
    if (newId === currentSectionId) return;
    const oldSection = document.getElementById(currentSectionId);
    const newSection = document.getElementById(newId);

    oldSection.style.opacity = '0';
    oldSection.style.transform = 'translateX(40px) scale(0.98)';

    setTimeout(() => {
      oldSection.classList.remove('active');
      newSection.classList.add('active');
      newSection.style.opacity = '0';
      newSection.style.transform = 'translateX(40px) scale(0.98)';
      requestAnimationFrame(() => {
        newSection.style.opacity = '1';
        newSection.style.transform = 'translateX(0) scale(1)';
        newSection.focus();
      });
      currentSectionId = newId;
    }, 350);
  }

  document.querySelectorAll('nav.sidebar button[data-section]').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('nav.sidebar button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      changeSection(btn.getAttribute('data-section'));
    });
  });

  // DATI INIZIALI - Come da vecchio codice
  let operatori = [
    { id: 1, nome: 'Mario Rossi', grado: 'Agente', ruolo: 'Operatore UOPI', stato: 'Disponibile' },
    { id: 2, nome: 'Luca Bianchi', grado: 'Ispettore', ruolo: 'Team Leader UOPI', stato: 'In Missione' },
    { id: 3, nome: 'Giuseppe Verdi', grado: 'Assistente', ruolo: 'Operatore Specializzato', stato: 'Disponibile' }
  ];

  let interventi = [
    { id: 1, descrizione: 'Controllo zona centrale Roma', assegnato: 'Mario Rossi', stato: 'In Corso' },
    { id: 2, descrizione: 'Pattugliamento stazione Termini', assegnato: 'Luca Bianchi', stato: 'In Attesa' }
  ];

  let formazioni = [
    { id: 1, operatore: 'Mario Rossi', certificazione: 'Uso armi automatiche', data_conseguimento: '2025-01-20', data_scadenza: '2026-01-20' },
    { id: 2, operatore: 'Luca Bianchi', certificazione: 'Leadership operativa', data_conseguimento: '2024-11-15', data_scadenza: '2025-11-15' }
  ];

  let equipaggiamenti = [
    { id: 1, operatore: 'Mario Rossi', equipaggiamento: 'HK UMP .40', quantita: 1 },
    { id: 2, operatore: 'Luca Bianchi', equipaggiamento: 'Beretta ARX 160', quantita: 1 },
    { id: 3, operatore: 'Giuseppe Verdi', equipaggiamento: 'Giubbotto antiproiettile', quantita: 1 }
  ];

  // References agli elementi DOM
  const operatoriTbody = document.getElementById('operatori-tbody');
  const interventiTbody = document.getElementById('interventi-tbody');
  const formazioneTbody = document.getElementById('formazione-tbody');
  const equipaggiamentiTbody = document.getElementById('equipaggiamenti-tbody');
  const operatoriList = document.getElementById('operatori-list');

  function updateOperatoriDatalist() {
    if(!operatoriList) return;
    operatoriList.innerHTML = '';
    operatori.forEach(op => {
      const option = document.createElement('option');
      option.value = op.nome;
      operatoriList.appendChild(option);
    });
  }

  // RENDER FUNCTIONS - Come da vecchio codice
  function renderOperatori() {
    operatoriTbody.innerHTML = '';
    operatori.forEach(op => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${op.nome}</td><td>${op.grado}</td><td>${op.ruolo}</td><td>${op.stato}</td><td class="actions"><button class="primary" onclick="editOperatore(${op.id})">Modifica</button> <button 
  aria-label="Elimina operatore"
  role="button"
  class="danger"
  onclick="deleteOperatore(${op.id})"
>
  <span class="sr-only">Elimina</span>
  <i class="icon-delete" aria-hidden="true"></i>
</button></td>`;
      operatoriTbody.appendChild(tr);
    });
    updateOperatoriDatalist();
    document.getElementById('operatori-count').textContent = operatori.length;
  }

  function renderInterventi() {
    interventiTbody.innerHTML = '';
    interventi.forEach(intv => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${intv.id}</td><td>${intv.descrizione}</td><td>${intv.assegnato}</td><td>${intv.stato}</td><td class="actions"><button class="primary" onclick="editIntervento(${intv.id})">Modifica</button> <button class="danger" onclick="deleteIntervento(${intv.id})">Elimina</button></td>`;
      interventiTbody.appendChild(tr);
    });
    document.getElementById('interventi-count').textContent = interventi.length;
  }

  function renderFormazioni() {
    formazioneTbody.innerHTML = '';
    formazioni.forEach(cert => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${cert.operatore}</td><td>${cert.certificazione}</td><td>${cert.data_conseguimento}</td><td>${cert.data_scadenza}</td><td class="actions"><button class="danger" onclick="deleteFormazione(${cert.id})">Elimina</button></td>`;
      formazioneTbody.appendChild(tr);
    });
  }

  function renderEquipaggiamenti() {
    equipaggiamentiTbody.innerHTML = '';
    equipaggiamenti.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.operatore}</td><td>${e.equipaggiamento}</td><td>${e.quantita}</td><td class="actions"><button class="danger" onclick="deleteEquipaggiamento(${e.id})">Elimina</button></td>`;
      equipaggiamentiTbody.appendChild(tr);
    });
  }

  // Form animation helpers
  function showForm(form) {
    form.classList.add('show');
  }
  function hideForm(form) {
    form.classList.remove('show');
    setTimeout(() => (form.style.display = 'none'), 500);
  }
  function displayForm(form) {
    form.style.display = 'block';
    requestAnimationFrame(() => showForm(form));
  }

  // GESTIONE OPERATORI - Completa come da vecchio codice
  const formOperatore = document.getElementById('form-operatore');
  const btnAddOperatore = document.getElementById('btn-add-operatore');
  const opCancelBtn = document.getElementById('op-cancel-btn');
  let editingOperatoreId = null;

  btnAddOperatore.addEventListener('click', () => {
    editingOperatoreId = null;
    formOperatore.reset();
    document.getElementById('form-title').textContent = 'Aggiungi Nuovo Operatore';
    displayForm(formOperatore);
    btnAddOperatore.style.display = 'none';
  });

  opCancelBtn.addEventListener('click', () => {
    hideForm(formOperatore);
    btnAddOperatore.style.display = 'inline-block';
  });

  formOperatore.addEventListener('submit', e => {
    e.preventDefault();
    const nome = document.getElementById('op-nome').value.trim();
    const grado = document.getElementById('op-grado').value;
    const ruolo = document.getElementById('op-ruolo').value.trim();
    const stato = document.getElementById('op-stato').value;

    if (editingOperatoreId) {
      operatori = operatori.map(op => (op.id === editingOperatoreId ? { id: op.id, nome, grado, ruolo, stato } : op));
    } else {
      const newId = operatori.length ? Math.max(...operatori.map(op => op.id)) + 1 : 1;
      operatori.push({ id: newId, nome, grado, ruolo, stato });
    }
    renderOperatori();
    hideForm(formOperatore);
    btnAddOperatore.style.display = 'inline-block';
  });

  function editOperatore(id) {
    const op = operatori.find(o => o.id === id);
    if (!op) return;
    editingOperatoreId = id;
    document.getElementById('form-title').textContent = 'Modifica Operatore';
    displayForm(formOperatore);
    btnAddOperatore.style.display = 'none';
    document.getElementById('op-nome').value = op.nome;
    document.getElementById('op-grado').value = op.grado;
    document.getElementById('op-ruolo').value = op.ruolo;
    document.getElementById('op-stato').value = op.stato;
  }

  function deleteOperatore(id) {
    if (confirm('Eliminare questo operatore?\n\nL\'operazione è irreversibile.')) {
      operatori = operatori.filter(op => op.id !== id);
      renderOperatori();
    }
  }

  // GESTIONE INTERVENTI - Completa
  const formIntervento = document.getElementById('form-intervento');
  const btnAddIntervento = document.getElementById('btn-add-intervento');
  const intCancelBtn = document.getElementById('int-cancel-btn');
  let editingInterventoId = null;

  btnAddIntervento.addEventListener('click', () => {
    editingInterventoId = null;
    formIntervento.reset();
    displayForm(formIntervento);
    btnAddIntervento.style.display = 'none';
  });

  intCancelBtn.addEventListener('click', () => {
    hideForm(formIntervento);
    btnAddIntervento.style.display = 'inline-block';
  });

  formIntervento.addEventListener('submit', e => {
    e.preventDefault();
    const descrizione = document.getElementById('int-desc').value.trim();
    const assegnato = document.getElementById('int-assegnato').value.trim();
    const stato = document.getElementById('int-stato').value;

    if (editingInterventoId) {
      interventi = interventi.map(intv => intv.id === editingInterventoId ? { id:intv.id, descrizione, assegnato, stato } : intv);
    } else {
      const newId = interventi.length ? Math.max(...interventi.map(i => i.id)) + 1 : 1;
      interventi.push({ id: newId, descrizione, assegnato, stato });
    }
    renderInterventi();
    hideForm(formIntervento);
    btnAddIntervento.style.display = 'inline-block';
  });

  function editIntervento(id) {
    const intv = interventi.find(i => i.id === id);
    if (!intv) return;
    editingInterventoId = id;
    displayForm(formIntervento);
    btnAddIntervento.style.display = 'none';
    document.getElementById('int-desc').value = intv.descrizione;
    document.getElementById('int-assegnato').value = intv.assegnato;
    document.getElementById('int-stato').value = intv.stato;
  }

  function deleteIntervento(id) {
    if (confirm('Eliminare questo intervento?')) {
      interventi = interventi.filter(i => i.id !== id);
      renderInterventi();
    }
  }

  // GESTIONE FORMAZIONE - Completa
  const formIstruzione = document.getElementById('form-istruzione');
  const btnAddIstruzione = document.getElementById('btn-add-istruzione');
  const certCancelBtn = document.getElementById('cert-cancel-btn');

  btnAddIstruzione.addEventListener('click', () => {
    formIstruzione.reset();
    displayForm(formIstruzione);
    btnAddIstruzione.style.display = 'none';
  });

  certCancelBtn.addEventListener('click', () => {
    hideForm(formIstruzione);
    btnAddIstruzione.style.display = 'inline-block';
  });

  formIstruzione.addEventListener('submit', e => {
    e.preventDefault();
    const operatore = document.getElementById('cert-op').value.trim();
    const certificazione = document.getElementById('cert-nome').value.trim();
    const data_conseguimento = document.getElementById('cert-data').value;
    const data_scadenza = document.getElementById('cert-scadenza').value;

    const newId = formazioni.length ? Math.max(...formazioni.map(c => c.id)) + 1 : 1;
    formazioni.push({ id: newId, operatore, certificazione, data_conseguimento, data_scadenza });
    renderFormazioni();
    hideForm(formIstruzione);
    btnAddIstruzione.style.display = 'inline-block';
  });

  function deleteFormazione(id) {
    if (confirm('Eliminare questa certificazione?')) {
      formazioni = formazioni.filter(f => f.id !== id);
      renderFormazioni();
    }
  }

  // GESTIONE EQUIPAGGIAMENTI - Completa
  const formEquip = document.getElementById('form-equip');
  const btnAddEquip = document.getElementById('btn-add-equip');
  const equipCancelBtn = document.getElementById('equip-cancel-btn');

  btnAddEquip.addEventListener('click', () => {
    formEquip.reset();
    displayForm(formEquip);
    btnAddEquip.style.display = 'none';
  });

  equipCancelBtn.addEventListener('click', () => {
    hideForm(formEquip);
    btnAddEquip.style.display = 'inline-block';
  });

  formEquip.addEventListener('submit', e => {
    e.preventDefault();
    const operatore = document.getElementById('equip-op').value.trim();
    const equipaggiamento = document.getElementById('equip-nome').value.trim();
    const quantita = parseInt(document.getElementById('equip-qty').value);

    const newId = equipaggiamenti.length ? Math.max(...equipaggiamenti.map(e => e.id)) + 1 : 1;
    equipaggiamenti.push({ id: newId, operatore, equipaggiamento, quantita });
    renderEquipaggiamenti();
    hideForm(formEquip);
    btnAddEquip.style.display = 'inline-block';
  });

  function deleteEquipaggiamento(id) {
    if (confirm('Eliminare questo equipaggiamento?')) {
      equipaggiamenti = equipaggiamenti.filter(e => e.id !== id);
      renderEquipaggiamenti();
    }
  }

  // REPORT - Come da vecchio codice
  const btnExportCsv = document.getElementById('btn-export-csv');
  const reportOutput = document.getElementById('report-output');

  btnExportCsv.addEventListener('click', () => {
    let csv = 'Nome,Grado,Ruolo,Stato Operativo\n';
    operatori.forEach(op => {
      csv += `"${op.nome}","${op.grado}","${op.ruolo}","${op.stato}"\n`;
    });
    reportOutput.textContent = csv;
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'operatori_uopi_report.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // CACHE SERVICE
const cacheService = {
  set(key, data, ttl = 3600) {
    const item = {
      value: data,
      timestamp: Date.now(),
      ttl: ttl * 1000
    };
    localStorage.setItem(key, JSON.stringify(item));
  },
  
  get(key) {
    const item = localStorage.getItem(key);
    if (!item) return null;
    
    const { value, timestamp, ttl } = JSON.parse(item);
    if (Date.now() - timestamp > ttl) {
      localStorage.removeItem(key);
      return null;
    }
    return value;
  }
};

  // NOTIFICHE
const notifications = {
  show(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  },
  
  error(message) {
    this.show(message, 'error');
  },
  
  success(message) {
    this.show(message, 'success');
  }
};

  // INIZIALIZZAZIONE DASHBOARD
  function initDashboard() {
    renderOperatori();
    renderInterventi();
    renderFormazioni();
    renderEquipaggiamenti();
  }

  function validateLoginForm(username, password) {
    const errors = [];
    
    if (!username) errors.push('Username obbligatorio');
    if (!password) errors.push('Password obbligatoria');
    
    return {
      isValid: errors.length === 0,
      errors
    };
  }
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Controlla se c'è un callback Discord
  if (window.location.hash) {
    handleDiscordCallback();
  }
  
  // Controlla sessione esistente
  const token = sessionStorage.getItem('discord_token');
  const userData = sessionStorage.getItem('user_data');
  
  if (token && userData) {
    handleSuccessfulLogin();
  }
});
</script>

</body>
</html>


