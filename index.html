<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://discord.com https://discordapp.com https://cdn.discordapp.com https://*.discord.com https://script.google.com https://script.googleusercontent.com; connect-src 'self' https://discord.com https://discordapp.com https://api.discord.com https://script.google.com https://script.googleusercontent.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<style>
  *, *::before, *::after { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0;
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #eee;
    overflow-x: hidden;
  }

  /* ‚ú® ANIMAZIONI AVANZATE */
  @keyframes slideInUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes progress {
    0% { width: 0%; }
    100% { width: 100%; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  @keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
  }

  @keyframes fadeInScale {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* üîÑ LOADING SCREEN MIGLIORATO */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease-out;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-logo {
    font-size: 72px;
    margin-bottom: 30px;
    color: #4299e1;
    animation: pulse 2s infinite;
    text-shadow: 0 0 20px rgba(66, 153, 225, 0.5);
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(66, 153, 225, 0.1);
    border-top: 4px solid #4299e1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  .loading-text {
    font-size: 18px;
    color: #a0aec0;
    margin-bottom: 30px;
    text-align: center;
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  .loading-progress {
    width: 350px;
    height: 8px;
    background: rgba(66, 153, 225, 0.1);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4299e1, #667eea, #8b5cf6);
    border-radius: 4px;
    width: 0%;
    animation: progress 4s ease-out forwards;
    box-shadow: 0 0 10px rgba(66, 153, 225, 0.5);
  }

  /* üö´ ACCESS DENIED SCREEN MIGLIORATO */
  .access-denied-section {
    display: none;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
    position: relative;
  }

  .access-denied-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    opacity: 0.1;
  }

  .access-denied-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(220, 38, 38, 0.3);
    max-width: 500px;
    width: 90%;
    text-align: center;
    position: relative;
    z-index: 1;
    animation: fadeInScale 0.5s ease-out;
  }

  .access-denied-icon {
    font-size: 100px;
    color: #dc2626;
    margin-bottom: 20px;
    animation: pulse 3s infinite;
    text-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
  }

  .access-denied-title {
    font-size: 32px;
    font-weight: 800;
    color: #dc2626;
    margin: 0 0 16px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .access-denied-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 30px 0;
    line-height: 1.6;
    opacity: 0.9;
  }

  .retry-button {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: none;
    padding: 18px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
  }

  .retry-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(220, 38, 38, 0.6);
  }

  /* üé® LOGIN SECTION MIGLIORATO */
  .login-section {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    position: relative;
  }

  .login-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
  }

  .login-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 480px;
    width: 90%;
    text-align: center;
    position: relative;
    z-index: 1;
    animation: fadeInScale 0.6s ease-out;
  }

  .login-logo {
    font-size: 72px;
    margin-bottom: 20px;
    display: block;
    text-shadow: 0 0 30px rgba(66, 153, 225, 0.5);
    animation: glow 3s infinite;
  }

  .login-title {
    font-size: 36px;
    font-weight: 800;
    color: #ffffff;
    margin: 0 0 12px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .login-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 40px 0;
    line-height: 1.6;
    opacity: 0.9;
  }

  .discord-login-button {
    background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
    color: white;
    border: none;
    padding: 20px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    box-shadow: 0 8px 30px rgba(88, 101, 242, 0.4);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .discord-login-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(88, 101, 242, 0.5);
  }

  .discord-login-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .discord-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .login-features {
    margin-top: 40px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    padding-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .feature-item {
    text-align: center;
    transition: transform 0.3s ease;
  }

  .feature-item:hover {
    transform: translateY(-2px);
  }

  .feature-icon {
    font-size: 28px;
    margin-bottom: 8px;
    display: block;
  }

  .feature-text {
    font-size: 12px;
    color: #cbd5e1;
    line-height: 1.3;
    font-weight: 500;
  }

  /* üè† MAIN DASHBOARD */
  .main-container {
    display: none;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  }

  /* üß≠ NAVIGATION MIGLIORATO */
  .dashboard-nav {
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    padding: 0;
    position: sticky;
    top: 0;
    z-index: 997;
    width: 100%;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  .nav-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    align-items: center;
    height: 80px;
    padding: 0 20px;
    max-width: none;
    margin: 0;
    gap: 20px;
  }

  .nav-brand {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 24px;
    font-weight: 800;
    color: #f1f5f9;
  }

  .nav-brand-icon {
    font-size: 32px;
    animation: pulse 4s infinite;
  }

  .nav-tabs {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(30, 41, 59, 0.8);
    border-radius: 20px;
    padding: 8px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    justify-self: start;
    flex-wrap: wrap;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .nav-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 18px;
    border-radius: 14px;
    background: transparent;
    border: none;
    color: #94a3b8;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    position: relative;
  }

  .nav-tab:hover {
    color: #f1f5f9;
    background: rgba(59, 130, 246, 0.15);
    transform: translateY(-1px);
  }

  .nav-tab.active {
    color: #ffffff;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
  }

  .nav-tab.admin-only {
    border: 1px solid rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.1);
    animation: glow 4s infinite;
  }

  .nav-tab.admin-only:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #fecaca;
  }

  .nav-tab-icon {
    font-size: 14px;
  }

  /* üë§ USER PROFILE MIGLIORATO */
  .user-profile-section {
    position: fixed;
    top: 15px;
    right: 15px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 20px;
    background: rgba(15, 23, 42, 0.98);
    backdrop-filter: blur(25px);
    z-index: 1000;
    border-radius: 16px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    max-width: 380px;
    min-width: 300px;
    animation: slideInUp 0.5s ease-out;
  }

  .user-avatar {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 18px;
    border: 2px solid #3b82f6;
    overflow: hidden;
    flex-shrink: 0;
    transition: all 0.3s ease;
  }

  .user-avatar:hover {
    transform: scale(1.05);
  }

  .user-avatar.admin {
    border: 2px solid #dc2626;
    box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
    animation: glow 3s infinite;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .user-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
    flex: 1;
    min-width: 0;
  }

  .user-name {
    font-weight: 600;
    font-size: 15px;
    color: #f1f5f9;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .user-name span:first-child {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 160px;
  }

  .admin-badge {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    color: #ffffff;
    padding: 3px 8px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
    animation: pulse 2s infinite;
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
  }

  .user-role {
    font-size: 12px;
    color: #64748b;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .header-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .header-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    color: #3b82f6;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .header-btn:hover {
    background: rgba(59, 130, 246, 0.2);
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  /* üìä DASHBOARD CONTENT MIGLIORATO */
  .dashboard {
    padding: 50px 30px;
    max-width: 1400px;
    margin: 0 auto;
    width: 100%;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 60px;
    animation: fadeInScale 0.6s ease-out;
  }

  .dashboard-title {
    font-size: 48px;
    font-weight: 900;
    color: #f1f5f9;
    margin: 0 0 16px 0;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .dashboard-subtitle {
    font-size: 20px;
    color: #64748b;
    margin: 0;
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  /* üèÜ ADMIN PANEL MIGLIORATO */
  .admin-panel {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: #ffffff;
    border-radius: 24px;
    padding: 35px;
    margin-bottom: 40px;
    box-shadow: 0 20px 40px rgba(220, 38, 38, 0.3);
    border: 1px solid rgba(220, 38, 38, 0.3);
    position: relative;
    overflow: hidden;
    animation: slideInUp 0.5s ease-out;
  }

  .admin-panel::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #fbbf24, #f59e0b);
  }

  .admin-panel h3 {
    margin: 0 0 25px 0;
    font-size: 24px;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 12px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .admin-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 18px;
  }

  .admin-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ffffff;
    padding: 16px 22px;
    border-radius: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  .admin-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  }

  /* ‚ö° QUICK ACTIONS MIGLIORATO */
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 25px;
    margin-bottom: 50px;
  }

  .quick-action-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: white;
    border: none;
    padding: 25px 30px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 16px;
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .quick-action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s ease;
  }

  .quick-action-btn:hover::before {
    left: 100%;
  }

  .quick-action-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 15px 35px rgba(59, 130, 246, 0.4);
  }

  .quick-action-icon {
    font-size: 24px;
  }

  /* üìä STATISTICS MIGLIORATO */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 60px;
  }

  .stat-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 24px;
    padding: 35px;
    text-align: center;
    border: 1px solid rgba(59, 130, 246, 0.2);
    position: relative;
    overflow: hidden;
    cursor: pointer;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
    transition: all 0.4s ease;
    animation: fadeInScale 0.5s ease-out;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  }

  .stat-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px rgba(59, 130, 246, 0.25);
  }

  .stat-number {
    font-size: 56px;
    font-weight: 900;
    color: #3b82f6;
    margin-bottom: 15px;
    line-height: 1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .stat-label {
    color: #94a3b8;
    font-size: 18px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* üóÇÔ∏è SECTIONS */
  .section-container {
    display: none;
  }

  .section-container.active {
    display: block;
    animation: slideInUp 0.5s ease-out;
  }

  /* üìã DASHBOARD CARDS MIGLIORATO */
  .dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 30px;
    margin-bottom: 50px;
  }

  .dashboard-card {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 24px;
    padding: 35px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
    transition: all 0.4s ease;
    animation: fadeInScale 0.5s ease-out;
  }

  .dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
  }

  .dashboard-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 30px 60px rgba(59, 130, 246, 0.2);
  }

  .dashboard-card h2 {
    margin: 0 0 30px 0;
    color: #f1f5f9;
    font-size: 22px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  /* üìä TABLES MIGLIORATO */
  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 25px;
    background: rgba(30, 41, 59, 0.8);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .data-table th,
  .data-table td {
    padding: 18px 22px;
    text-align: left;
    border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  }

  .data-table th {
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    color: #ffffff;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .data-table tr:hover {
    background: rgba(59, 130, 246, 0.1);
    transform: scale(1.01);
    transition: all 0.2s ease;
  }

  .data-table tr:last-child td {
    border-bottom: none;
  }

  /* üè∑Ô∏è STATUS BADGES MIGLIORATO */
  .status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  }

  .status-active { 
    background: linear-gradient(135deg, #10b981, #059669); 
    color: #ffffff;
  }

  .status-inactive { 
    background: linear-gradient(135deg, #ef4444, #dc2626); 
    color: #ffffff;
  }

  .status-in-progress { 
    background: linear-gradient(135deg, #3b82f6, #2563eb); 
    color: #ffffff;
  }

  .status-assigned { 
    background: linear-gradient(135deg, #f59e0b, #d97706); 
    color: #ffffff;
  }

  /* üéØ SPECIAL FEATURES MIGLIORATO */
  .feature-highlight {
    background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
    border-radius: 20px;
    padding: 30px;
    margin: 30px 0;
    color: white;
    text-align: center;
    box-shadow: 0 15px 35px rgba(139, 92, 246, 0.3);
    animation: fadeInScale 0.6s ease-out;
  }

  .error-message, .success-message {
    padding: 18px 24px;
    border-radius: 12px;
    margin: 20px 0;
    display: none;
    font-weight: 500;
    animation: slideInUp 0.3s ease-out;
  }

  .error-message {
    background: linear-gradient(135deg, #fed7d7, #feb2b2);
    color: #9b2c2c;
    border-left: 4px solid #e53e3e;
  }

  .success-message {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
    border-left: 4px solid #10b981;
  }

  /* üì± RESPONSIVE MIGLIORATO */
  @media (max-width: 1200px) {
    .nav-container {
      grid-template-columns: 250px 1fr;
    }
    
    .nav-tabs {
      gap: 4px;
    }
    
    .nav-tab {
      padding: 10px 14px;
      font-size: 12px;
    }
  }

  @media (max-width: 1024px) {
    .nav-container {
      grid-template-columns: 1fr;
      height: auto;
      padding: 15px 20px;
      gap: 15px;
    }
    
    .nav-brand {
      justify-self: center;
    }
    
    .nav-tabs {
      justify-self: center;
      width: 100%;
      justify-content: center;
    }
    
    .user-profile-section {
      position: relative;
      top: auto;
      right: auto;
      margin: 15px auto;
      max-width: 500px;
    }
  }

  @media (max-width: 768px) {
    .user-profile-section {
      margin: 15px 15px;
      min-width: auto;
      width: calc(100% - 30px);
    }
    
    .dashboard {
      padding: 25px 15px;
    }
    
    .dashboard-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    .quick-actions {
      grid-template-columns: 1fr;
    }

    .login-container, .access-denied-container {
      padding: 40px 30px;
      margin: 20px;
    }

    .login-features {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .dashboard-title {
      font-size: 36px;
    }
    
    .stat-number {
      font-size: 42px;
    }
  }
</style>
</head>

<body>
<!-- üîÑ Loading Screen -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-logo">üöî</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Caricamento Dashboard UOPI...</div>
  <div class="loading-progress">
    <div class="loading-progress-bar"></div>
  </div>
</div>

<!-- üö´ Access Denied Screen -->
<div id="access-denied-section" class="access-denied-section">
  <div class="access-denied-container">
    <div class="access-denied-icon">üö´</div>
    <h1 class="access-denied-title">Accesso Negato</h1>
    <p class="access-denied-subtitle">Il tuo account Discord non √® presente nella lista autorizzata della dashboard UOPI.<br><br>Contatta l'amministratore per richiedere l'accesso al sistema.</p>
    <button class="retry-button" onclick="DiscordAuth.logout()">
      üîÑ Riprova con altro account
    </button>
  </div>
</div>

<!-- üé® Login Section -->
<div id="login-section" class="login-section">
  <div class="login-container">
    <div class="login-header">
      <span class="login-logo">üöî</span>
      <h1 class="login-title">UOPI Dashboard</h1>
      <p class="login-subtitle">Sistema di Gestione Unit√† Operative<br>Accedi con il tuo account Discord autorizzato</p>
    </div>
    
    <button id="discord-login-btn" class="discord-login-button">
      <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418Z"/>
      </svg>
      Accedi con Discord
    </button>
    
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>
    
    <div class="login-features">
      <div class="feature-item">
        <span class="feature-icon">üîê</span>
        <div class="feature-text">Accesso<br>Sicuro</div>
      </div>
      <div class="feature-item">
        <span class="feature-icon">‚ö°</span>
        <div class="feature-text">Sistema<br>Garantito</div>
      </div>
      <div class="feature-item">
        <span class="feature-icon">üõ°Ô∏è</span>
        <div class="feature-text">Lista<br>Autorizzata</div>
      </div>
    </div>
  </div>
</div>

<!-- üè† Main Dashboard -->
<div id="main-container" class="main-container">
  <!-- üß≠ Navigation -->
  <nav class="dashboard-nav">
    <div class="nav-container">
      <div class="nav-brand">
        <span class="nav-brand-icon">üöî</span>
        UOPI Dashboard
      </div>
      
      <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchSection('overview')">
          <span class="nav-tab-icon">üìä</span>
          Panoramica
        </button>
        <button class="nav-tab" onclick="switchSection('operatori')">
          <span class="nav-tab-icon">üëÆ‚Äç‚ôÇÔ∏è</span>
          Operatori
        </button>
        <button class="nav-tab" onclick="switchSection('interventi')">
          <span class="nav-tab-icon">üö®</span>
          Interventi
        </button>
        <button class="nav-tab" onclick="switchSection('formazione')">
          <span class="nav-tab-icon">üìã</span>
          Formazione
        </button>
        <button class="nav-tab" onclick="switchSection('equipaggiamenti')">
          <span class="nav-tab-icon">üõ°Ô∏è</span>
          Equipaggiamenti
        </button>
        <button class="nav-tab admin-only" onclick="switchSection('admin')" style="display: none;">
          <span class="nav-tab-icon">‚öôÔ∏è</span>
          Amministrazione
        </button>
        <button class="nav-tab admin-only" onclick="switchSection('reports')" style="display: none;">
          <span class="nav-tab-icon">üìà</span>
          Report
        </button>
      </div>
    </div>
  </nav>

  <!-- üë§ User Profile -->
  <div class="user-profile-section">
    <div class="user-avatar" id="user-avatar">
      <span id="user-initial">?</span>
    </div>
    <div class="user-info">
      <div class="user-name" id="user-name">
        <span>Caricamento...</span>
        <span id="admin-badge" class="admin-badge" style="display: none;">DIRIGENZA</span>
      </div>
      <div class="user-role" id="user-role">Operatore UOPI</div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="DiscordAuth.logout()" title="Logout">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 13v-2H7V8l-5 4 5 4v-3z"/>
          <path d="M20 3h-9c-1.103 0-2 .897-2 2v4h2V5h9v14h-9v-4H9v4c0 1.103.897 2 2 2h9c1.103 0 2-.897 2-2V5c0-1.103-.897-2-2-2z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- üìä Dashboard Content -->
  <div class="dashboard">
    <div class="dashboard-header">
      <h1 class="dashboard-title">Sistema UOPI</h1>
      <p class="dashboard-subtitle">Gestione Unit√† Operative di Polizia Italiana - FiveM</p>
    </div>
    
    <!-- üèÜ Admin Panel -->
    <div id="admin-panel" class="admin-panel" style="display: none;">
      <h3>
        <span>üëë</span>
        Pannello Dirigenza Autorizzata
      </h3>
      <div class="admin-controls">
        <button class="admin-btn" onclick="showModal('Gestione Utenti UOPI', 'Sistema di gestione completo degli utenti autorizzati nella lista fissa del Google Apps Script')">
          <span>üë•</span>
          Gestisci Utenti
        </button>
        <button class="admin-btn" onclick="showModal('Impostazioni Sistema', 'Configurazione avanzata del sistema UOPI con lista autorizzazioni garantita')">
          <span>‚öôÔ∏è</span>
          Impostazioni
        </button>
        <button class="admin-btn" onclick="showModal('Backup Database', 'Creazione backup sicuro dei dati operativi con sistema sempre funzionante')">
          <span>üíæ</span>
          Backup Dati
        </button>
        <button class="admin-btn" onclick="showModal('Log Sistema', 'Monitoraggio attivit√† e controllo accessi con debug completo')">
          <span>üìÑ</span>
          Log Sistema
        </button>
        <button class="admin-btn" onclick="showModal('Lista Autorizzazioni', 'Gestione lista fissa degli ID Discord autorizzati')">
          <span>üîê</span>
          Lista Autorizzazioni
        </button>
        <button class="admin-btn" onclick="showModal('Sistema Garantito', 'Monitoraggio sistema sempre funzionante con fallback automatico')">
          <span>üõ°Ô∏è</span>
          Sistema Garantito
        </button>
      </div>
    </div>

    <!-- ‚ö° Quick Actions -->
    <div class="quick-actions">
      <button class="quick-action-btn" onclick="showModal('Nuovo Intervento UOPI', 'Creazione di un nuovo intervento operativo con assegnazione automatica delle squadre')">
        <span class="quick-action-icon">üö®</span>
        Nuovo Intervento
      </button>
      <button class="quick-action-btn" onclick="showModal('Rapporto Turno', 'Compilazione rapporto di fine turno con salvataggio automatico nel sistema')">
        <span class="quick-action-icon">üìù</span>
        Rapporto Turno
      </button>
      <button class="quick-action-btn" onclick="showModal('Richiesta Supporto', 'Richiesta supporto urgente da altri reparti con notifica immediata')">
        <span class="quick-action-icon">üÜò</span>
        Richiesta Supporto
      </button>
      <button class="quick-action-btn" onclick="showModal('Gestione Mezzi', 'Controllo stato e assegnazione mezzi operativi in tempo reale')">
        <span class="quick-action-icon">üöó</span>
        Gestione Mezzi
      </button>
    </div>
    
    <!-- üìä Overview Section -->
    <div id="section-overview" class="section-container active">
      <div class="stats-grid">
        <div class="stat-card" onclick="showModal('Operatori UOPI Dettagli', 'Visualizzazione dettagliata di tutti gli operatori autorizzati dal sistema')">
          <div class="stat-number">15</div>
          <div class="stat-label">Operatori Autorizzati</div>
        </div>
        <div class="stat-card" onclick="showModal('Operazioni Dettagli', 'Riepilogo delle operazioni attualmente in corso con aggiornamenti in tempo reale')">
          <div class="stat-number">8</div>
          <div class="stat-label">Operazioni Attive</div>
        </div>
        <div class="stat-card" onclick="showModal('Squadre Dettagli', 'Stato e composizione delle squadre operative UOPI')">
          <div class="stat-number">4</div>
          <div class="stat-label">Squadre Operative</div>
        </div>
        <div class="stat-card" onclick="showModal('Sistema Status', 'Stato del sistema con lista autorizzazioni sempre funzionante')">
          <div class="stat-number">100</div>
          <div class="stat-label">% Sistema Attivo</div>
        </div>
      </div>

      <div class="feature-highlight">
        <h3>üéØ Sistema UOPI Garantito al 100%</h3>
        <p>Dashboard completamente funzionale con lista autorizzazioni fissa e sistema di accesso sempre garantito. Non dipende pi√π da fogli esterni - il tuo accesso √® permanentemente assicurato nella lista hardcoded del Google Apps Script.</p>
      </div>
    </div>

    <!-- üëÆ‚Äç‚ôÇÔ∏è Operatori Section -->
    <div id="section-operatori" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>üëÆ‚Äç‚ôÇÔ∏è Operatori UOPI Autorizzati</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Grado</th>
                <th>Ruolo</th>
                <th>Stato Sistema</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Tonino Frasca</td>
                <td>Comandante Generale</td>
                <td>üëë Dirigenza Generale</td>
                <td><span class="status-badge status-active">Lista Fissa</span></td>
                <td>
                  <button class="admin-btn" style="padding: 8px 16px; font-size: 12px; margin: 0;" onclick="showModal('Profilo Tonino Frasca', 'Gestione profilo Comandante Generale con accesso garantito al sistema')">Gestisci</button>
                </td>
              </tr>
              <tr>
                <td>Gabriel Martinelli</td>
                <td>Comandante</td>
                <td>üí´ Dirigenza Generale</td>
                <td><span class="status-badge status-active">Lista Fissa</span></td>
                <td>
                  <button class="admin-btn" style="padding: 8px 16px; font-size: 12px; margin: 0;" onclick="showModal('Profilo Gabriel Martinelli', 'Gestione profilo Comandante con autorit√† operativa completa')">Gestisci</button>
                </td>
              </tr>
              <tr>
                <td>Franco Costa</td>
                <td>Vice Comandante</td>
                <td>üåü Dirigenza Generale</td>
                <td><span class="status-badge status-active">Lista Fissa</span></td>
                <td>
                  <button class="admin-btn" style="padding: 8px 16px; font-size: 12px; margin: 0;" onclick="showModal('Profilo Franco Costa', 'Gestione profilo Vice Comandante con funzioni dirigenziali')">Gestisci</button>
                </td>
              </tr>
              <tr>
                <td>Diego Bianchi</td>
                <td>Sostituto Vice Comandante</td>
                <td>‚≠ê Dirigenza Generale</td>
                <td><span class="status-badge status-active">Lista Fissa</span></td>
                <td>
                  <button class="admin-btn" style="padding: 8px 16px; font-size: 12px; margin: 0;" onclick="showModal('Profilo Diego Bianchi', 'Gestione profilo con responsabilit√† operative')">Gestisci</button>
                </td>
              </tr>
              <tr>
                <td>Simone Brighella</td>
                <td>Sostituto Vice Comandante</td>
                <td>‚≠ê Dirigenza Generale</td>
                <td><span class="status-badge status-active">Lista Fissa</span></td>
                <td>
                  <button class="admin-btn" style="padding: 8px 16px; font-size: 12px; margin: 0;" onclick="showModal('Profilo Simone Brighella', 'Gestione profilo operativo dirigenziale')">Gestisci</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- üö® Interventi Section -->
    <div id="section-interventi" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>üö® Gestione Interventi UOPI</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>ID Intervento</th>
                <th>Tipologia</th>
                <th>Squadra Assegnata</th>
                <th>Stato</th>
                <th>Priorit√†</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>#UOPI-001</td>
                <td>Controllo territorio Centro</td>
                <td>Squadra Alpha</td>
                <td><span class="status-badge status-in-progress">In Corso</span></td>
                <td><span class="status-badge status-assigned">Media</span></td>
              </tr>
              <tr>
                <td>#UOPI-002</td>
                <td>Incidente stradale SS1</td>
                <td>Squadra Bravo</td>
                <td><span class="status-badge status-assigned">Assegnato</span></td>
                <td><span class="status-badge status-active">Alta</span></td>
              </tr>
              <tr>
                <td>#UOPI-003</td>
                <td>Controllo documentale</td>
                <td>Squadra Charlie</td>
                <td><span class="status-badge status-active">Completato</span></td>
                <td><span class="status-badge status-assigned">Bassa</span></td>
              </tr>
              <tr>
                <td>#UOPI-004</td>
                <td>Supporto evento pubblico</td>
                <td>Squadra Delta</td>
                <td><span class="status-badge status-in-progress">In Preparazione</span></td>
                <td><span class="status-badge status-assigned">Media</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- üìã Formazione Section -->
    <div id="section-formazione" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>üìã Formazione e Certificazioni UOPI</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>Operatore</th>
                <th>Certificazione</th>
                <th>Conseguimento</th>
                <th>Scadenza</th>
                <th>Stato</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Tonino Frasca</td>
                <td>Comando e Controllo Avanzato</td>
                <td>15/03/2024</td>
                <td>15/03/2027</td>
                <td><span class="status-badge status-active">Valida</span></td>
              </tr>
              <tr>
                <td>Gabriel Martinelli</td>
                <td>Gestione Emergenze</td>
                <td>22/01/2024</td>
                <td>22/01/2027</td>
                <td><span class="status-badge status-active">Valida</span></td>
              </tr>
              <tr>
                <td>Franco Costa</td>
                <td>Primo Soccorso Avanzato</td>
                <td>10/12/2023</td>
                <td>10/12/2025</td>
                <td><span class="status-badge status-assigned">In Scadenza</span></td>
              </tr>
              <tr>
                <td>Diego Bianchi</td>
                <td>Investigazioni Speciali</td>
                <td>05/08/2024</td>
                <td>05/08/2027</td>
                <td><span class="status-badge status-active">Valida</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- üõ°Ô∏è Equipaggiamenti Section -->
    <div id="section-equipaggiamenti" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>üõ°Ô∏è Equipaggiamenti UOPI</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>Equipaggiamento</th>
                <th>Assegnato a</th>
                <th>Quantit√†</th>
                <th>Stato</th>
                <th>Ultima Manutenzione</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Radio Tattica Digitale</td>
                <td>Squadra Alpha</td>
                <td>4</td>
                <td><span class="status-badge status-active">Operativo</span></td>
                <td>01/09/2025</td>
              </tr>
              <tr>
                <td>Giubbotto Antiproiettile NIJ IIIA</td>
                <td>Tutti gli operatori</td>
                <td>15</td>
                <td><span class="status-badge status-active">Operativo</span></td>
                <td>15/08/2025</td>
              </tr>
              <tr>
                <td>Dispositivo Taser X26P</td>
                <td>Squadra Bravo</td>
                <td>2</td>
                <td><span class="status-badge status-assigned">Manutenzione</span></td>
                <td>20/07/2025</td>
              </tr>
              <tr>
                <td>Veicolo Blindato Iveco Daily</td>
                <td>Squadra Delta</td>
                <td>1</td>
                <td><span class="status-badge status-active">Operativo</span></td>
                <td>10/09/2025</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚öôÔ∏è Admin Section -->
    <div id="section-admin" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>‚öôÔ∏è Gestione Sistema UOPI</h2>
          <div style="padding: 25px;">
            <h4>üéõÔ∏è Controlli Avanzati Dirigenza</h4>
            <p>Accesso completo a tutte le funzionalit√† di amministrazione del sistema UOPI con lista autorizzazioni hardcoded e sistema sempre funzionante al 100%.</p>
            <button class="quick-action-btn" onclick="showModal('Sistema Autorizzazioni', 'Gestione lista fissa degli utenti autorizzati nel Google Apps Script')">
              <span>üë•</span>
              Lista Autorizzazioni Fissa
            </button>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>üîß Sistema Garantito</h2>
          <div style="padding: 25px;">
            <h4>‚öôÔ∏è Funzionamento Sempre Attivo</h4>
            <p>Sistema con lista hardcoded che garantisce il funzionamento al 100% indipendentemente da connessioni esterne o fogli Google Sheets.</p>
            <button class="quick-action-btn" onclick="showModal('Status Sistema', 'Monitoraggio sistema sempre attivo con lista autorizzazioni fissa')">
              <span>üõ°Ô∏è</span>
              Sistema Sempre Attivo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- üìà Reports Section -->
    <div id="section-reports" class="section-container">
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <h2>üìà Report Operativi UOPI</h2>
          <div style="padding: 25px;">
            <h4>üìä Analytics Sistema Garantito</h4>
            <p>Report dettagliati sulle performance operative con sistema di accesso sempre funzionante e lista autorizzazioni fissa.</p>
            <button class="quick-action-btn" onclick="showModal('Report Sistema', 'Generazione report con sistema sempre attivo e accesso garantito')">
              <span>üìã</span>
              Report Sistema Garantito
            </button>
          </div>
        </div>
        <div class="dashboard-card">
          <h2>üìä Statistiche Avanzate</h2>
          <div style="padding: 25px;">
            <h4>üéØ Monitoraggio Sistema</h4>
            <p>Dashboard analytics complete con monitoraggio del sistema hardcoded e lista autorizzazioni sempre funzionante.</p>
            <button class="quick-action-btn" onclick="showModal('Analytics Sistema', 'Dashboard analytics con sistema sempre attivo')">
              <span>üìà</span>
              Analytics Sistema
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// üöî CONFIGURAZIONE FINALE - SISTEMA GARANTITO
const CONFIG = {
  DISCORD: {
    CLIENT_ID: '1387801645743869982',
    REDIRECT_URI: 'https://ryze-glitch.github.io/uopi-dashboard/',
    SCOPE: 'identify'
  },
  // üìã GOOGLE APPS SCRIPT API - LISTA FISSA HARDCODED
  API: {
    URL: 'https://script.google.com/macros/s/AKfycbzcTGSXyzxY5SRwnM6paqNHwhY4UqZM1Xy1pjUpS7_r/exec'
  }
};

// üîÑ Loading Manager Avanzato
class LoadingManager {
  static show(text = 'Caricamento Dashboard UOPI...') {
    const loading = document.getElementById('loading-overlay');
    const loadingText = loading.querySelector('.loading-text');
    loadingText.textContent = text;
    loading.classList.add('show');
  }
  
  static hide() {
    setTimeout(() => {
      const loading = document.getElementById('loading-overlay');
      loading.classList.add('hidden');
      setTimeout(() => {
        loading.classList.remove('show', 'hidden');
      }, 500);
    }, 1200);
  }
  
  static updateText(text) {
    const loading = document.getElementById('loading-overlay');
    const loadingText = loading.querySelector('.loading-text');
    if (loadingText) {
      loadingText.textContent = text;
    }
  }
}

// üìã Access Control - SISTEMA LISTA FISSA GARANTITO
class AccessControl {
  static async fetchUserData() {
    try {
      console.log('üîç Connessione a Google Apps Script con lista fissa...');
      LoadingManager.updateText('Verifica lista autorizzazioni...');
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);
      
      const response = await fetch(CONFIG.API.URL, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache'
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Errore API');
      }
      
      console.log(`‚úÖ Sistema ${data.debug.source} - Trovati ${data.count} utenti autorizzati`);
      console.log('üîë Lista ID hardcoded:', data.allowedUsers);
      console.log('üéØ IL TUO ID incluso:', data.debug.yourIdIncluded ? '‚úÖ S√å' : '‚ùå NO');
      
      LoadingManager.updateText('Lista autorizzazioni caricata...');
      
      return data;
      
    } catch (error) {
      console.error('‚ùå Errore connessione Google Apps Script:', error);
      LoadingManager.updateText('Attivazione sistema di emergenza locale...');
      
      // üÜò FALLBACK LOCALE ASSOLUTO
      console.log('üÜò Attivo sistema di emergenza locale...');
      return {
        success: true,
        count: 1,
        allowedUsers: ['817121576217870348'], // IL TUO ID SEMPRE GARANTITO
        users: [{
          id: '817121576217870348',
          discordId: '817121576217870348',
          nome: 'Tonino Frasca',
          ruolo: 'üëë Comandante Generale',
          admin: true,
          source: 'local_emergency_guaranteed'
        }],
        debug: {
          source: 'LOCAL_EMERGENCY_GUARANTEED',
          yourIdIncluded: true,
          message: 'Sistema di emergenza - Accesso sempre garantito'
        }
      };
    }
  }
  
  static async checkUserAccess(discordUserID) {
    try {
      LoadingManager.updateText('Controllo autorizzazioni...');
      
      const data = await this.fetchUserData();
      
      console.log('üîç Verifica accesso per Discord ID:', discordUserID);
      
      // ‚úÖ CONTROLLO NELLA LISTA FISSA
      const isAuthorized = data.allowedUsers && data.allowedUsers.includes(discordUserID);
      
      let userDetails = null;
      if (isAuthorized && data.users) {
        userDetails = data.users.find(user => user.id === discordUserID || user.discordId === discordUserID);
      }
      
      // Log dettagliato
      console.log(`üìä Risultato controllo accesso:`);
      console.log(`   Discord ID: ${discordUserID}`);
      console.log(`   Nella lista: ${isAuthorized ? '‚úÖ S√å' : '‚ùå NO'}`);
      console.log(`   Fonte dati: ${data.debug?.source || 'UNKNOWN'}`);
      console.log(`   Dettagli:`, userDetails);
      console.log(`   Totale autorizzati: ${data.count}`);
      
      if (isAuthorized) {
        console.log(`‚úÖ ACCESSO AUTORIZZATO per ${discordUserID}`);
        
        const finalUserData = userDetails || { 
          id: discordUserID, 
          nome: 'Operatore UOPI', 
          ruolo: 'üëë Comandante Generale', 
          admin: true // Tutti sono admin nella lista fissa
        };
        
        return {
          hasAccess: true,
          userData: finalUserData,
          source: data.debug?.source
        };
      } else {
        console.log(`‚ùå ACCESSO NEGATO per ${discordUserID}`);
        console.log('üìã Lista autorizzazioni disponibile:', data.allowedUsers);
        return {
          hasAccess: false,
          userData: null,
          source: data.debug?.source
        };
      }
      
    } catch (error) {
      console.error('‚ùå Errore controllo accessi:', error);
      LoadingManager.hide();
      return {
        hasAccess: false,
        userData: null,
        error: error.message
      };
    }
  }
}

// üóÇÔ∏è Section Manager
function switchSection(sectionName) {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  document.querySelectorAll('.section-container').forEach(section => {
    section.classList.remove('active');
  });
  
  event.target.classList.add('active');
  document.getElementById(`section-${sectionName}`).classList.add('active');
}

// üéØ Modal System Avanzato
function showModal(title, description) {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease-out;
    backdrop-filter: blur(5px);
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 24px;
      padding: 35px;
      max-width: 520px;
      width: 90%;
      text-align: center;
      border: 1px solid rgba(59, 130, 246, 0.2);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
      transform: scale(0.9);
      animation: modalPop 0.4s ease-out forwards;
      position: relative;
    ">
      <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 24px 24px 0 0;"></div>
      <div style="font-size: 56px; margin-bottom: 20px; animation: pulse 3s infinite;">üöî</div>
      <h2 style="color: #3b82f6; margin-bottom: 18px; font-size: 24px; font-weight: 800;">${title}</h2>
      <p style="color: #94a3b8; margin-bottom: 28px; line-height: 1.6; font-size: 15px;">${description}</p>
      <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        color: white;
        border: none;
        padding: 14px 28px;
        border-radius: 14px;
        font-weight: 600;
        cursor: pointer;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(59, 130, 246, 0.5)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(59, 130, 246, 0.4)'">
        ‚úÖ Compreso
      </button>
    </div>
  `;
  
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes modalPop {
      from { transform: scale(0.9); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
  
  // Auto-chiusura dopo 10 secondi
  setTimeout(() => {
    if (modal.parentNode) {
      modal.style.animation = 'fadeOut 0.4s ease-out forwards';
      setTimeout(() => modal.remove(), 400);
    }
  }, 10000);
}

// üîê Discord OAuth - SISTEMA GARANTITO
class DiscordAuth {
  static async login() {
    try {
      console.log('üîê Avvio login con sistema lista fissa garantito...');
      
      const existingToken = this.getStoredToken();
      if (existingToken) {
        LoadingManager.show('Verifica sessione esistente...');
        const userData = await this.fetchUserData(existingToken);
        if (userData) {
          const accessResult = await AccessControl.checkUserAccess(userData.id);
          if (accessResult.hasAccess) {
            LoadingManager.updateText('Accesso confermato dalla lista...');
            setTimeout(() => {
              UI.showDashboard(userData, accessResult.userData);
              LoadingManager.hide();
            }, 800);
          } else {
            LoadingManager.hide();
            UI.showAccessDenied();
          }
          return;
        }
      }

      LoadingManager.show('Avvio autenticazione Discord...');

      const params = new URLSearchParams({
        client_id: CONFIG.DISCORD.CLIENT_ID,
        redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
        response_type: 'token',
        scope: CONFIG.DISCORD.SCOPE,
        prompt: 'consent'
      });

      window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
    } catch (error) {
      console.error('Login error:', error);
      LoadingManager.hide();
      UI.showError('Errore durante il login: ' + error.message);
    }
  }

  static async handleCallback() {
    try {
      if (!window.location.hash) return;
      
      const fragment = new URLSearchParams(window.location.hash.slice(1));
      const token = fragment.get('access_token');
      const error = fragment.get('error');
      
      if (error === 'access_denied') {
        LoadingManager.show('Reindirizzamento autorizzazione...');
        const params = new URLSearchParams({
          client_id: CONFIG.DISCORD.CLIENT_ID,
          redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
          response_type: 'token',
          scope: CONFIG.DISCORD.SCOPE,
          prompt: 'consent'
        });
        window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        return;
      }
      
      if (!token) return;

      window.history.replaceState(null, null, window.location.pathname);
      
      LoadingManager.show('Verifica credenziali Discord...');
      
      const userData = await this.fetchUserData(token);
      if (!userData) throw new Error('Dati utente Discord non validi');

      LoadingManager.updateText('Controllo lista autorizzazioni...');
      
      // üîç CONTROLLO CON LISTA FISSA
      const accessResult = await AccessControl.checkUserAccess(userData.id);
      
      if (!accessResult.hasAccess) {
        LoadingManager.hide();
        UI.showAccessDenied();
        console.log(`‚ùå Accesso negato per ${userData.username} (${userData.id}) - Non in lista fissa`);
        return;
      }

      this.saveSession(token, userData);
      localStorage.setItem('discord_authorized', 'true');
      
      console.log(`‚úÖ Accesso autorizzato per ${userData.username} (${userData.id}) dalla lista fissa`);
      
      if (accessResult.source && accessResult.source.includes('EMERGENCY')) {
        LoadingManager.updateText('Sistema di emergenza - Accesso dirigenza garantito!');
        setTimeout(() => {
          UI.showSuccess('Sistema di emergenza attivato - Il tuo accesso √® sempre garantito');
        }, 2000);
      } else {
        LoadingManager.updateText('Accesso confermato dalla lista hardcoded!');
      }
      
      setTimeout(() => {
        UI.showDashboard(userData, accessResult.userData);
        LoadingManager.hide();
      }, 1500);
      
    } catch (error) {
      console.error('Callback error:', error);
      LoadingManager.hide();
      UI.showError('Errore di autenticazione: ' + error.message);
      this.logout();
    }
  }

  static async fetchUserData(token) {
    try {
      const response = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Discord API error');
      return response.json();
    } catch (error) {
      console.error('Fetch user data error:', error);
      return null;
    }
  }

  static saveSession(token, userData) {
    localStorage.setItem('discord_token', token);
    localStorage.setItem('user_data', JSON.stringify(userData));
    localStorage.setItem('login_timestamp', Date.now().toString());
  }

  static getStoredToken() {
    const token = localStorage.getItem('discord_token');
    const timestamp = localStorage.getItem('login_timestamp');
    
    if (token && timestamp) {
      const now = Date.now();
      const loginTime = parseInt(timestamp);
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      
      if (now - loginTime < sevenDays) {
        return token;
      }
    }
    
    return null;
  }

  static getStoredUserData() {
    const userData = localStorage.getItem('user_data');
    return userData ? JSON.parse(userData) : null;
  }

  static logout() {
    localStorage.clear();
    window.location.reload();
  }

  static async checkExistingSession() {
    const token = this.getStoredToken();
    const userData = this.getStoredUserData();
    
    if (token && userData) {
      LoadingManager.show('Controllo sessione salvata...');
      const freshUserData = await this.fetchUserData(token);
      if (freshUserData) {
        const accessResult = await AccessControl.checkUserAccess(freshUserData.id);
        if (accessResult.hasAccess) {
          LoadingManager.updateText('Sessione valida - Accesso dalla lista...');
          setTimeout(() => {
            UI.showDashboard(userData, accessResult.userData);
            LoadingManager.hide();
          }, 1000);
          return true;
        } else {
          UI.showAccessDenied();
          return true;
        }
      }
    }
    return false;
  }
}

// üé® UI Management - DIRIGENZA AUTOMATICA
class UI {
  static showDashboard(discordUserData, systemUserData) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('access-denied-section').style.display = 'none';
    document.getElementById('main-container').style.display = 'block';
    this.updateProfile(discordUserData, systemUserData);
    this.checkAdminStatus(systemUserData);
  }

  static showAccessDenied() {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-container').style.display = 'none';
    document.getElementById('access-denied-section').style.display = 'flex';
  }

  static updateProfile(discordData, systemData) {
    const userNameEl = document.getElementById('user-name');
    const userInitialEl = document.getElementById('user-initial');
    const userAvatarEl = document.getElementById('user-avatar');
    const userRoleEl = document.getElementById('user-role');

    // Usa i dati dal sistema se disponibili, altrimenti Discord
    const displayName = systemData?.nome || discordData.username || 'Operatore UOPI';
    const displayRole = systemData?.ruolo || 'Operatore UOPI';

    if (displayName) {
      userNameEl.querySelector('span').textContent = displayName;
      userInitialEl.textContent = displayName.charAt(0).toUpperCase();
      userRoleEl.textContent = displayRole;
    }

    if (discordData.avatar) {
      const avatarUrl = `https://cdn.discordapp.com/avatars/${discordData.id}/${discordData.avatar}.png?size=128`;
      userAvatarEl.innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
    }
  }

  static checkAdminStatus(systemUserData) {
    if (!systemUserData) {
      console.log('üëÆ‚Äç‚ôÇÔ∏è Operatore standard');
      return;
    }
    
    // üèÜ TUTTI NELLA LISTA FISSA SONO ADMIN
    const isAdmin = systemUserData.admin === true || true; // Forza admin per lista fissa
    
    if (isAdmin) {
      // Mostra badge dirigenza
      document.getElementById('admin-badge').style.display = 'inline-block';
      document.getElementById('user-avatar').classList.add('admin');
      document.getElementById('admin-panel').style.display = 'block';
      
      // Mostra tab admin
      document.querySelectorAll('.admin-only').forEach(tab => {
        tab.style.display = 'flex';
      });
      
      console.log('üèÜ DIRIGENZA attivata automaticamente:', systemUserData);
      
      // Messaggio di benvenuto personalizzato
      let welcomeMessage = `Benvenuto ${systemUserData.nome || 'Dirigente UOPI'}!`;
      if (systemUserData.source && systemUserData.source.includes('EMERGENCY')) {
        welcomeMessage += ' Sistema di emergenza attivo - Il tuo accesso √® sempre garantito dalla lista hardcoded.';
      } else {
        welcomeMessage += ' Accesso confermato dalla lista autorizzazioni fissa - Sistema sempre funzionante.';
      }
      
      setTimeout(() => {
        showModal('Accesso Dirigenza UOPI Garantito', welcomeMessage);
      }, 2500);
    } else {
      console.log('üëÆ‚Äç‚ôÇÔ∏è Operatore standard dalla lista:', systemUserData);
    }
  }

  static showError(message) {
    const errorEl = document.getElementById('error-message');
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 8000);
    }
  }
  
  static showSuccess(message) {
    const successEl = document.getElementById('success-message');
    if (successEl) {
      successEl.textContent = message;
      successEl.style.display = 'block';
      
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 10000);
    }
  }
}

// üöÄ Initialize - SISTEMA LISTA FISSA GARANTITO
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöî === INIZIALIZZAZIONE DASHBOARD UOPI SISTEMA GARANTITO ===');
  console.log('üìã Google Apps Script API:', CONFIG.API.URL);
  console.log('üîê Discord Client ID:', CONFIG.DISCORD.CLIENT_ID);
  console.log('üõ°Ô∏è Sistema Lista Fissa: ATTIVO E GARANTITO');
  console.log('üéØ Il tuo ID 817121576217870348 √® SEMPRE incluso');
  
  if (window.location.hash && window.location.hash.includes('access_token')) {
    console.log('üîÑ Gestione callback Discord OAuth...');
    await DiscordAuth.handleCallback();
    return;
  }
  
  const hasExistingSession = await DiscordAuth.checkExistingSession();
  
  if (!hasExistingSession) {
    // ‚úÖ EVENT LISTENER PRINCIPALE
    const discordBtn = document.getElementById('discord-login-btn');
    if (discordBtn) {
      discordBtn.addEventListener('click', function() {
        console.log('üîê Login avviato - Sistema lista fissa garantito');
        this.disabled = true;
        this.innerHTML = `
          <div style="width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;display:inline-block;margin-right:10px;"></div>
          Accesso in corso...
        `;
        DiscordAuth.login();
      });
      console.log('‚úÖ Event listener configurato - Sistema garantito attivo');
    } else {
      console.error('‚ùå ERRORE: Bottone Discord non trovato!');
    }
  }
  
  console.log('üöî === INIZIALIZZAZIONE COMPLETATA ===');
  console.log('üî• SISTEMA AL 100% GARANTITO - IL TUO ACCESSO √à SEMPRE ASSICURATO!');
});
</script>

</body>
</html>
