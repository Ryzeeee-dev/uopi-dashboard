<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<style>
  *, *::before, *::after { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0;
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #eee;
    overflow-x: hidden;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  @keyframes slideInUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* üîÑ LOADING SCREEN */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-logo {
    font-size: 72px;
    margin-bottom: 30px;
    color: #4299e1;
    animation: pulse 2s infinite;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(66, 153, 225, 0.1);
    border-top: 4px solid #4299e1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  .loading-text {
    font-size: 18px;
    color: #a0aec0;
    text-align: center;
    margin-bottom: 20px;
  }

  /* üö´ ACCESS DENIED SCREEN */
  .access-denied-section {
    display: none;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  }

  .access-denied-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(220, 38, 38, 0.3);
    max-width: 500px;
    width: 90%;
    text-align: center;
  }

  .access-denied-icon {
    font-size: 100px;
    color: #dc2626;
    margin-bottom: 20px;
    animation: pulse 3s infinite;
  }

  .access-denied-title {
    font-size: 32px;
    font-weight: 800;
    color: #dc2626;
    margin: 0 0 16px 0;
  }

  .access-denied-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 20px 0;
    line-height: 1.6;
  }

  .debug-info {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #94a3b8;
    text-align: left;
  }

  .retry-button {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: none;
    padding: 18px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  /* üé® LOGIN SECTION */
  .login-section {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .login-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 480px;
    width: 90%;
    text-align: center;
  }

  .login-logo {
    font-size: 72px;
    margin-bottom: 20px;
    display: block;
  }

  .login-title {
    font-size: 36px;
    font-weight: 800;
    color: #ffffff;
    margin: 0 0 12px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .login-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 40px 0;
    line-height: 1.6;
  }

  .discord-login-button {
    background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
    color: white;
    border: none;
    padding: 20px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    box-shadow: 0 8px 30px rgba(88, 101, 242, 0.4);
    transition: all 0.3s ease;
  }

  .discord-login-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(88, 101, 242, 0.5);
  }

  .discord-login-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .discord-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  /* üè† MAIN DASHBOARD */
  .main-container {
    display: none;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    padding: 50px 30px;
    text-align: center;
    animation: slideInUp 0.5s ease-out;
  }

  .dashboard-title {
    font-size: 48px;
    font-weight: 900;
    color: #f1f5f9;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .user-info-card {
    background: rgba(26, 32, 44, 0.95);
    border-radius: 20px;
    padding: 30px;
    max-width: 600px;
    margin: 0 auto 30px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  }

  .admin-badge {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    color: #ffffff;
    padding: 8px 16px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    display: inline-block;
    margin: 10px 0;
    animation: pulse 2s infinite;
  }

  .logout-btn {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s ease;
  }

  .logout-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
  }

  .success-info {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    color: #10b981;
    padding: 15px;
    border-radius: 12px;
    margin: 20px 0;
    font-weight: 500;
  }

  /* üì± RESPONSIVE */
  @media (max-width: 768px) {
    .login-container, .access-denied-container {
      padding: 40px 30px;
      margin: 20px;
    }
    
    .main-container {
      padding: 25px 15px;
    }
    
    .dashboard-title {
      font-size: 36px;
    }
  }
</style>
</head>

<body>
<!-- üîÑ Loading Screen -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-logo">üöî</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Caricamento Dashboard UOPI...</div>
</div>

<!-- üö´ Access Denied Screen -->
<div id="access-denied-section" class="access-denied-section">
  <div class="access-denied-container">
    <div class="access-denied-icon">üö´</div>
    <h1 class="access-denied-title">Accesso Negato</h1>
    <p class="access-denied-subtitle">Il tuo account Discord non √® autorizzato.</p>
    <div id="debug-info" class="debug-info"></div>
    <button class="retry-button" onclick="logout()">
      üîÑ Riprova con altro account
    </button>
  </div>
</div>

<!-- üé® Login Section -->
<div id="login-section" class="login-section">
  <div class="login-container">
    <span class="login-logo">üöî</span>
    <h1 class="login-title">UOPI Dashboard</h1>
    <p class="login-subtitle">Sistema di Gestione Unit√† Operative<br>Accedi con il tuo account Discord</p>
    
    <button id="discord-login-btn" class="discord-login-button">
      <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418Z"/>
      </svg>
      Accedi con Discord
    </button>
  </div>
</div>

<!-- üè† Main Dashboard -->
<div id="main-container" class="main-container">
  <h1 class="dashboard-title">üöî Dashboard UOPI</h1>
  
  <div class="user-info-card">
    <h2>Benvenuto nella Dashboard UOPI</h2>
    <div class="admin-badge">üëë DIRIGENZA AUTORIZZATA</div>
    
    <div class="success-info">
      ‚úÖ Sistema Bypass Attivo - Accesso garantito senza Google Apps Script
    </div>
    
    <div id="user-details" style="margin: 20px 0; text-align: left;">
      <p><strong>Nome:</strong> <span id="user-name-display">Caricamento...</span></p>
      <p><strong>Ruolo:</strong> <span id="user-role-display">üëë Comandante Generale</span></p>
      <p><strong>Discord ID:</strong> <span id="user-id-display">Caricamento...</span></p>
      <p><strong>Livello:</strong> <span style="color: #dc2626; font-weight: bold;">üëë Dirigenza Completa</span></p>
      <p><strong>Sistema:</strong> <span style="color: #10b981;">‚úÖ Bypass Hardcoded - Sempre Funzionante</span></p>
    </div>
    
    <button class="logout-btn" onclick="logout()">
      üö™ Esci dalla Dashboard
    </button>
  </div>
  
  <div style="margin-top: 30px; color: #64748b; font-size: 14px;">
    <p>üî• Sistema Bypass - Non dipende da Google Apps Script</p>
    <p>üõ°Ô∏è Lista hardcoded - Accesso sempre garantito</p>
    <p>‚ö° Funzionamento al 100% - Nessuna dipendenza esterna</p>
  </div>
</div>

<script>
// üöî SISTEMA BYPASS TOTALE - SENZA GOOGLE APPS SCRIPT
const CONFIG = {
  DISCORD: {
    CLIENT_ID: '1387801645743869982',
    REDIRECT_URI: 'https://ryze-glitch.github.io/uopi-dashboard/',
    SCOPE: 'identify'
  }
};

// üîë LISTA HARDCODED - SEMPRE FUNZIONANTE
const AUTHORIZED_USERS = {
  '817121576217870348': {
    nome: 'Tonino Frasca',
    ruolo: 'üëë Comandante Generale',
    admin: true
  },
  '1387684968536477756': {
    nome: 'Gabriel Martinelli',
    ruolo: 'üí´ Comandante',
    admin: true
  },
  '796078370176487454': {
    nome: 'Simone Sottaceto',
    ruolo: 'üåü Vice Comandante',
    admin: true
  },
  '814941325916241930': {
    nome: 'Matteo Rossi',
    ruolo: '‚≠ê Sostituto Vice Comandante',
    admin: true
  },
  '1062981395644948550': {
    nome: 'Franco Costa',
    ruolo: 'üåü Vice Comandante',
    admin: true
  },
  '734406288213016607': {
    nome: 'Diego Bianchi',
    ruolo: '‚≠ê Sostituto Vice Comandante',
    admin: true
  },
  '1249738701081155658': {
    nome: 'Simone Brighella',
    ruolo: '‚≠ê Sostituto Vice Comandante',
    admin: true
  }
};

// üîÑ Loading Manager
function showLoading(text = 'Caricamento Dashboard UOPI...') {
  const loading = document.getElementById('loading-overlay');
  const loadingText = loading.querySelector('.loading-text');
  loadingText.textContent = text;
  loading.classList.add('show');
}

function hideLoading() {
  setTimeout(() => {
    const loading = document.getElementById('loading-overlay');
    loading.classList.remove('show');
  }, 1000);
}

// ‚úÖ Controllo accesso HARDCODED
function checkAccess(discordUserID) {
  console.log('üîç Controllo accesso per ID:', discordUserID);
  console.log('üîë Lista utenti autorizzati:', Object.keys(AUTHORIZED_USERS));
  
  const user = AUTHORIZED_USERS[discordUserID];
  
  if (user) {
    console.log('‚úÖ ACCESSO AUTORIZZATO:', user);
    return {
      hasAccess: true,
      userData: user
    };
  } else {
    console.log('‚ùå ACCESSO NEGATO - ID non in lista hardcoded');
    return {
      hasAccess: false,
      userData: null,
      debugInfo: {
        discordId: discordUserID,
        authorized: false,
        totalAuthorized: Object.keys(AUTHORIZED_USERS).length,
        authorizedIds: Object.keys(AUTHORIZED_USERS).slice(0, 5)
      }
    };
  }
}

// üîê Discord OAuth
async function discordLogin() {
  try {
    console.log('üîê Avvio login Discord - Sistema Bypass');
    
    const existingToken = getStoredToken();
    if (existingToken) {
      showLoading('Verifica sessione esistente...');
      const userData = await fetchUserData(existingToken);
      if (userData) {
        const accessResult = checkAccess(userData.id);
        if (accessResult.hasAccess) {
          showDashboard(userData, accessResult.userData);
          hideLoading();
        } else {
          showAccessDenied(accessResult.debugInfo);
          hideLoading();
        }
        return;
      }
    }

    showLoading('Reindirizzamento a Discord...');

    const params = new URLSearchParams({
      client_id: CONFIG.DISCORD.CLIENT_ID,
      redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
      response_type: 'token',
      scope: CONFIG.DISCORD.SCOPE,
      prompt: 'consent'
    });

    window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
  } catch (error) {
    console.error('Login error:', error);
    hideLoading();
  }
}

async function handleCallback() {
  try {
    if (!window.location.hash) return;
    
    const fragment = new URLSearchParams(window.location.hash.slice(1));
    const token = fragment.get('access_token');
    
    if (!token) return;

    window.history.replaceState(null, null, window.location.pathname);
    
    showLoading('Verifica credenziali Discord...');
    
    const userData = await fetchUserData(token);
    if (!userData) throw new Error('Dati utente Discord non validi');

    console.log('üë§ Dati Discord ricevuti:', userData);
    
    // ‚úÖ CONTROLLO CON LISTA HARDCODED
    const accessResult = checkAccess(userData.id);
    
    if (!accessResult.hasAccess) {
      showAccessDenied(accessResult.debugInfo);
      hideLoading();
      return;
    }

    saveSession(token, userData);
    
    console.log(`‚úÖ Accesso autorizzato per ${userData.username} (${userData.id})`);
    
    setTimeout(() => {
      showDashboard(userData, accessResult.userData);
      hideLoading();
    }, 1000);
    
  } catch (error) {
    console.error('Callback error:', error);
    hideLoading();
    logout();
  }
}

async function fetchUserData(token) {
  try {
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!response.ok) throw new Error('Discord API error');
    return response.json();
  } catch (error) {
    console.error('Fetch user data error:', error);
    return null;
  }
}

function saveSession(token, userData) {
  localStorage.setItem('discord_token', token);
  localStorage.setItem('user_data', JSON.stringify(userData));
  localStorage.setItem('login_timestamp', Date.now().toString());
}

function getStoredToken() {
  const token = localStorage.getItem('discord_token');
  const timestamp = localStorage.getItem('login_timestamp');
  
  if (token && timestamp) {
    const now = Date.now();
    const loginTime = parseInt(timestamp);
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    
    if (now - loginTime < sevenDays) {
      return token;
    }
  }
  
  return null;
}

function logout() {
  localStorage.clear();
  window.location.reload();
}

// üé® UI Functions
function showDashboard(discordUserData, systemUserData) {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('access-denied-section').style.display = 'none';
  document.getElementById('main-container').style.display = 'block';
  
  // Aggiorna le informazioni utente
  document.getElementById('user-name-display').textContent = systemUserData?.nome || discordUserData.username || 'N/A';
  document.getElementById('user-id-display').textContent = discordUserData.id;
  
  console.log('‚úÖ Dashboard caricata - Sistema Bypass attivo');
}

function showAccessDenied(debugInfo) {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('main-container').style.display = 'none';
  document.getElementById('access-denied-section').style.display = 'flex';
  
  // Mostra info di debug
  if (debugInfo) {
    const debugEl = document.getElementById('debug-info');
    debugEl.innerHTML = `
      <strong>Sistema Bypass - Debug Info:</strong><br>
      Discord ID: ${debugInfo.discordId}<br>
      Autorizzato: ${debugInfo.authorized ? '‚úÖ' : '‚ùå'}<br>
      Sistema: Lista Hardcoded<br>
      Totale autorizzati: ${debugInfo.totalAuthorized}<br>
      Primi 5 ID: ${debugInfo.authorizedIds.join(', ')}
    `;
  }
}

async function checkExistingSession() {
  const token = getStoredToken();
  const userData = JSON.parse(localStorage.getItem('user_data') || 'null');
  
  if (token && userData) {
    showLoading('Controllo sessione salvata...');
    const freshUserData = await fetchUserData(token);
    if (freshUserData) {
      const accessResult = checkAccess(freshUserData.id);
      if (accessResult.hasAccess) {
        setTimeout(() => {
          showDashboard(userData, accessResult.userData);
          hideLoading();
        }, 1000);
        return true;
      } else {
        showAccessDenied(accessResult.debugInfo);
        hideLoading();
        return true;
      }
    }
  }
  return false;
}

// üöÄ Inizializzazione
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöî === INIZIALIZZAZIONE DASHBOARD UOPI SISTEMA BYPASS ===');
  console.log('üîë Utenti autorizzati hardcoded:', Object.keys(AUTHORIZED_USERS).length);
  console.log('üéØ Il tuo ID 817121576217870348:', AUTHORIZED_USERS['817121576217870348'] ? '‚úÖ INCLUSO' : '‚ùå MANCANTE');
  console.log('üéØ Gabriel ID 1387684968536477756:', AUTHORIZED_USERS['1387684968536477756'] ? '‚úÖ INCLUSO' : '‚ùå MANCANTE');
  console.log('üõ°Ô∏è Sistema: 100% Indipendente - Nessuna dipendenza esterna');
  
  if (window.location.hash && window.location.hash.includes('access_token')) {
    console.log('üîÑ Gestione callback Discord OAuth...');
    await handleCallback();
    return;
  }
  
  const hasExistingSession = await checkExistingSession();
  
  if (!hasExistingSession) {
    // ‚úÖ EVENT LISTENER LOGIN BUTTON
    const discordBtn = document.getElementById('discord-login-btn');
    if (discordBtn) {
      discordBtn.addEventListener('click', function() {
        console.log('üîê Login avviato - Sistema Bypass');
        this.disabled = true;
        this.innerHTML = `
          <div style="width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;display:inline-block;margin-right:10px;"></div>
          Accesso in corso...
        `;
        discordLogin();
      });
      console.log('‚úÖ Event listener configurato - Sistema Bypass');
    }
  }
  
  console.log('üöî === INIZIALIZZAZIONE COMPLETATA ===');
  console.log('üî• SISTEMA BYPASS ATTIVO - FUNZIONAMENTO GARANTITO AL 100%!');
});
</script>

</body>
</html>
