<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://discord.com https://discordapp.com https://cdn.discordapp.com https://*.discord.com; connect-src 'self' https://discord.com https://discordapp.com https://api.discord.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<style>
  /* Reset */
  *, *::before, *::after { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #1a202c;
    color: #eee;
  }
  
  /* Header con profilo utente */
  .user-profile-section {
    position: fixed;
    top: 0;
    right: 0;
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px 25px;
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(10px);
    z-index: 1000;
    border-bottom-left-radius: 15px;
  }
  
  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
    border: 2px solid #4299e1;
    overflow: hidden;
  }
  
  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .user-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  
  .user-name {
    font-weight: 600;
    font-size: 14px;
    color: #e2e8f0;
  }
  
  .user-role {
    font-size: 12px;
    color: #a0aec0;
  }
  
  .header-actions {
    display: flex;
    gap: 10px;
  }
  
  .header-btn {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(66, 153, 225, 0.1);
    border: 1px solid rgba(66, 153, 225, 0.3);
    color: #4299e1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }
  
  .header-btn:hover {
    background: rgba(66, 153, 225, 0.2);
    transform: scale(1.05);
  }
  
  /* Schermata di login */
  #login-section {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  #stars {
    position: absolute;
    width: 100%;
    height: 100%;
    background: transparent;
    animation: animateStars 50s linear infinite;
  }

  #stars:before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(2px 2px at 100px 50px, #fff, transparent),
                radial-gradient(2px 2px at 400px 180px, #fff, transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 2px at 300px 100px, #fff, transparent),
                radial-gradient(2px 1px at 500px 70px, #fff, transparent);
    background-repeat: repeat;
    background-size: 550px 250px;
    animation: animateStars 10s linear infinite;
    opacity: 0.5;
  }

  @keyframes animateStars {
    from { transform: translateY(0px); }
    to { transform: translateY(-1000px); }
  }

  /* Animazione impulso per notifiche */
  @keyframes pulse {
    0% { opacity: 0; transform: scale(0); }
    50% { opacity: 0.5; transform: scale(1); }
    100% { opacity: 0; transform: scale(0); }
  }

  #login-form-container {
    position: relative;
    z-index: 2;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 24px;
    padding: 40px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    animation: slideInUp 0.8s ease;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .uopi-logo {
    width: 120px;
    height: 120px;
    margin: 0 auto 20px;
    display: block;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  }

  #login-title {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 8px 0;
    background: linear-gradient(45deg, #ffffff, #e2e8f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }

  .login-subtitle {
    font-size: 14px;
    color: rgba(255, 255, 255, 0.8);
    margin: 0 0 30px 0;
    line-height: 1.4;
  }

  .discord-login {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, #5865f2, #4752c4);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4);
  }

  .discord-login:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(88, 101, 242, 0.6);
  }

  .discord-login:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }

  .discord-icon {
    width: 20px;
    height: 20px;
  }

  .loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Dashboard */
  #dashboard {
    display: none;
    padding-top: 80px;
    min-height: 100vh;
    background: #1a202c;
  }

  .dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  .dashboard-header {
    text-align: center;
    margin-bottom: 40px;
  }

  .dashboard-title {
    font-size: 36px;
    font-weight: 700;
    margin: 0 0 10px 0;
    background: linear-gradient(45deg, #4299e1, #667eea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .dashboard-subtitle {
    font-size: 18px;
    color: #a0aec0;
    margin: 0;
  }

  .section-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
  }

  .section-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 24px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }

  .section-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: rgba(66, 153, 225, 0.3);
  }

  .section-title {
    font-size: 20px;
    font-weight: 600;
    margin: 0 0 20px 0;
    color: #e2e8f0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-icon {
    width: 24px;
    height: 24px;
    fill: #4299e1;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    border-radius: 8px;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.02);
  }

  th {
    background: rgba(66, 153, 225, 0.1);
    color: #e2e8f0;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 2px solid rgba(66, 153, 225, 0.2);
  }

  td {
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    color: #cbd5e0;
    font-size: 14px;
  }

  tr:hover {
    background: rgba(66, 153, 225, 0.05);
  }

  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-active {
    background: rgba(72, 187, 120, 0.2);
    color: #68d391;
    border: 1px solid rgba(72, 187, 120, 0.3);
  }

  .status-inactive {
    background: rgba(245, 101, 101, 0.2);
    color: #fc8181;
    border: 1px solid rgba(245, 101, 101, 0.3);
  }

  .status-in-progress {
    background: rgba(66, 153, 225, 0.2);
    color: #63b3ed;
    border: 1px solid rgba(66, 153, 225, 0.3);
  }

  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 6px;
  }

  .btn-edit {
    background: rgba(66, 153, 225, 0.2);
    color: #63b3ed;
    border: 1px solid rgba(66, 153, 225, 0.3);
  }

  .btn-edit:hover {
    background: rgba(66, 153, 225, 0.3);
    transform: scale(1.05);
  }

  .btn-delete {
    background: rgba(245, 101, 101, 0.2);
    color: #fc8181;
    border: 1px solid rgba(245, 101, 101, 0.3);
  }

  .btn-delete:hover {
    background: rgba(245, 101, 101, 0.3);
    transform: scale(1.05);
  }

  .btn-view {
    background: rgba(72, 187, 120, 0.2);
    color: #68d391;
    border: 1px solid rgba(72, 187, 120, 0.3);
  }

  .btn-view:hover {
    background: rgba(72, 187, 120, 0.3);
    transform: scale(1.05);
  }

  /* Notifiche */
  .notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    pointer-events: none;
  }

  .notification {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(15px);
    border-left: 4px solid;
    border-radius: 8px;
    padding: 16px 20px;
    margin-bottom: 10px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    transform: translateX(400px);
    transition: all 0.3s ease;
    pointer-events: auto;
    min-width: 300px;
    max-width: 400px;
  }

  .notification.show {
    transform: translateX(0);
  }

  .notification.success {
    border-left-color: #68d391;
  }

  .notification.error {
    border-left-color: #fc8181;
  }

  .notification.info {
    border-left-color: #63b3ed;
  }

  .notification-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #e2e8f0;
  }

  .notification-message {
    color: #cbd5e0;
    font-size: 14px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .section-grid {
      grid-template-columns: 1fr;
    }
    
    .user-profile-section {
      padding: 10px 15px;
    }
    
    .dashboard-container {
      padding: 15px;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 8px 6px;
    }
  }

  /* Blur background per notifiche */
  .notification-blur {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backdrop-filter: blur(3px);
    background: rgba(0, 0, 0, 0.1);
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .notification-blur.active {
    opacity: 1;
  }
</style>
</head>

<body>

<!-- Sezione Login -->
<div id="login-section">
  <div id="stars"></div>
  <div id="login-form-container">
    <img src="./Distintivo_UOPI_della_Polizia_di_Stato-removebg-preview.png" alt="UOPI Logo" class="uopi-logo">
    <h1 id="login-title">Dashboard UOPI</h1>
    <p class="login-subtitle">Sistema di Gestione Unità Operative di Polizia Italiana</p>
    
    <button class="discord-login" id="discord-login-btn" onclick="attemptDiscordLogin()">
      <svg class="discord-icon" viewBox="0 0 24 24">
        <path fill="currentColor" d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
      </svg>
      <span id="login-button-text">Accedi con Discord</span>
    </button>
  </div>
</div>

<!-- Dashboard principale -->
<div id="dashboard">
  <!-- Header con profilo utente -->
  <div class="user-profile-section">
    <div class="user-avatar" id="user-avatar">
      <img id="user-avatar-img" src="" alt="" style="display: none;">
      <span id="user-avatar-text">?</span>
    </div>
    <div class="user-info">
      <div class="user-name" id="user-name">Caricamento...</div>
      <div class="user-role" id="user-role">Operatore UOPI</div>
    </div>
    <div class="header-actions">
      <button class="header-btn" onclick="showNotification('Impostazioni', 'Funzionalità in sviluppo', 'info')" title="Impostazioni">
        ⚙️
      </button>
      <button class="header-btn" onclick="logout()" title="Logout">
        🚪
      </button>
    </div>
  </div>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <h1 class="dashboard-title">Dashboard Gestione UOPI</h1>
      <p class="dashboard-subtitle">Sistema di Gestione Unità Operative di Polizia Italiana</p>
    </div>

    <div class="section-grid">
      <!-- Operatori UOPI -->
      <div class="section-card">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Operatori UOPI
        </h2>
        <table>
          <thead>
            <tr>
              <th>Nome</th>
              <th>Grado</th>
              <th>Ruolo</th>
              <th>Stato Operativo</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Marco Rossi</td>
              <td>Sovrintendente</td>
              <td>Coordinatore</td>
              <td><span class="status-badge status-active">Attivo</span></td>
              <td>
                <button class="action-btn btn-view">Visualizza</button>
                <button class="action-btn btn-edit">Modifica</button>
              </td>
            </tr>
            <tr>
              <td>Luigi Bianchi</td>
              <td>Ispettore</td>
              <td>Investigatore</td>
              <td><span class="status-badge status-active">Attivo</span></td>
              <td>
                <button class="action-btn btn-view">Visualizza</button>
                <button class="action-btn btn-edit">Modifica</button>
              </td>
            </tr>
            <tr>
              <td>Anna Verdi</td>
              <td>Agente</td>
              <td>Pattuglia</td>
              <td><span class="status-badge status-inactive">Non Attivo</span></td>
              <td>
                <button class="action-btn btn-view">Visualizza</button>
                <button class="action-btn btn-edit">Modifica</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Gestione Interventi -->
      <div class="section-card">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-.14 0-.27.01-.4.04-.39.08-.74.28-1.01.55-.18.18-.33.4-.43.64-.1.23-.16.49-.16.77v14c0 .27.06.54.16.78.1.23.25.45.43.64.27.27.62.47 1.01.55.13.02.26.03.4.03h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7-.25c.41 0 .75.34.75.75s-.34.75-.75.75-.75-.34-.75-.75.34-.75.75-.75zM19 19H5V5h14v14z"/>
          </svg>
          Gestione Interventi
        </h2>
        <table>
          <thead>
            <tr>
              <th>ID Intervento</th>
              <th>Descrizione</th>
              <th>Assegnato a</th>
              <th>Stato</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>#001</td>
              <td>Controllo routine via Roma</td>
              <td>Marco Rossi</td>
              <td><span class="status-badge status-in-progress">In Corso</span></td>
              <td>
                <button class="action-btn btn-view">Dettagli</button>
                <button class="action-btn btn-edit">Modifica</button>
              </td>
            </tr>
            <tr>
              <td>#002</td>
              <td>Incidente stradale A1</td>
              <td>Luigi Bianchi</td>
              <td><span class="status-badge status-active">Assegnato</span></td>
              <td>
                <button class="action-btn btn-view">Dettagli</button>
                <button class="action-btn btn-edit">Modifica</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Formazione e Certificazioni -->
      <div class="section-card">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M5,3C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C0,3.89 20.11,3 19,3H5M7,7H17V9H7V7M7,11H17V13H7V11M7,15H13V17H7V15Z"/>
          </svg>
          Formazione e Certificazioni
        </h2>
        <table>
          <thead>
            <tr>
              <th>Operatore</th>
              <th>Certificazione</th>
              <th>Data conseguimento</th>
              <th>Data scadenza</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Marco Rossi</td>
              <td>Primo Soccorso</td>
              <td>15/03/2024</td>
              <td>15/03/2026</td>
              <td>
                <button class="action-btn btn-view">Certificato</button>
                <button class="action-btn btn-edit">Rinnova</button>
              </td>
            </tr>
            <tr>
              <td>Luigi Bianchi</td>
              <td>Investigazioni</td>
              <td>22/01/2024</td>
              <td>22/01/2027</td>
              <td>
                <button class="action-btn btn-view">Certificato</button>
                <button class="action-btn btn-edit">Rinnova</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Equipaggiamenti -->
      <div class="section-card">
        <h2 class="section-title">
          <svg class="section-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
          </svg>
          Equipaggiamenti
        </h2>
        <table>
          <thead>
            <tr>
              <th>Operatore</th>
              <th>Equipaggiamento</th>
              <th>Quantità</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Marco Rossi</td>
              <td>Radio portatile</td>
              <td>1</td>
              <td>
                <button class="action-btn btn-edit">Modifica</button>
                <button class="action-btn btn-delete">Rimuovi</button>
              </td>
            </tr>
            <tr>
              <td>Luigi Bianchi</td>
              <td>Giubbotto antiproiettile</td>
              <td>1</td>
              <td>
                <button class="action-btn btn-edit">Modifica</button>
                <button class="action-btn btn-delete">Rimuovi</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Container per notifiche -->
<div class="notification-container" id="notification-container"></div>
<div class="notification-blur" id="notification-blur"></div>

<script>
// Configurazione Discord OAuth
const DISCORD_CLIENT_ID = 'YOUR_CLIENT_ID_HERE'; // Sostituisci con il tuo Client ID
const REDIRECT_URI = window.location.origin + window.location.pathname;

// Variabili globali
let currentUser = null;
let isLoading = false;

// Sistema di notifiche migliorato
const notifications = {
  container: null,
  blur: null,
  
  init() {
    this.container = document.getElementById('notification-container');
    this.blur = document.getElementById('notification-blur');
  },
  
  show(title, message, type = 'info', duration = 4000) {
    if (!this.container) this.init();
    
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    notification.innerHTML = `
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    `;
    
    this.container.appendChild(notification);
    
    // Attiva blur sullo sfondo
    if (this.blur) {
      this.blur.classList.add('active');
    }
    
    // Mostra notifica
    requestAnimationFrame(() => {
      notification.classList.add('show');
    });
    
    // Rimuovi automaticamente
    setTimeout(() => {
      this.remove(notification);
    }, duration);
    
    // Rimuovi al click
    notification.addEventListener('click', () => {
      this.remove(notification);
    });
    
    return notification;
  },
  
  remove(notification) {
    if (!notification || !notification.parentElement) return;
    
    notification.classList.remove('show');
    
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
        
        // Rimuovi blur se non ci sono più notifiche
        if (this.container && this.container.children.length === 0 && this.blur) {
          this.blur.classList.remove('active');
        }
      }
    }, 300);
  },
  
  success(title, message) {
    return this.show(title, message, 'success');
  },
  
  error(title, message) {
    return this.show(title, message, 'error', 6000);
  },
  
  info(title, message) {
    return this.show(title, message, 'info');
  }
};

// Funzione per mostrare notifiche (compatibilità)
function showNotification(title, message, type = 'info') {
  notifications.show(title, message, type);
}

// Funzione principale per tentativo login Discord
function attemptDiscordLogin() {
  console.log('🚀 Tentativo di login Discord...');
  
  // Verifica configurazione
  if (DISCORD_CLIENT_ID === 'YOUR_CLIENT_ID_HERE') {
    console.error('❌ Client ID non configurato');
    notifications.error('Configurazione mancante', 'Imposta il Discord Client ID nel codice');
    return;
  }
  
  loginWithDiscord();
}

// Funzione per login Discord migliorata
function loginWithDiscord() {
  const loginBtn = document.getElementById('discord-login-btn');
  const loginButtonText = document.getElementById('login-button-text');
  
  try {
    // Verifica che gli elementi esistano
    if (!loginBtn) {
      console.error('❌ Button di login non trovato');
      notifications.error('Errore UI', 'Elemento button non trovato');
      return;
    }
    
    // Disabilita button e mostra loading
    loginBtn.disabled = true;
    if (loginButtonText) {
      loginButtonText.innerHTML = '<div class="loading-spinner"></div> Reindirizzamento...';
    }
    
    // Parametri OAuth Discord
    const params = new URLSearchParams({
      client_id: DISCORD_CLIENT_ID,
      redirect_uri: REDIRECT_URI,
      response_type: 'token',
      scope: 'identify',
      prompt: 'consent'
    });
    
    const authUrl = `https://discord.com/oauth2/authorize?${params}`;
    console.log('🔗 Auth URL:', authUrl);
    
    // Reindirizza a Discord
    window.location.replace(authUrl);
    
  } catch (err) {
    console.error('❌ Errore login:', err);
    notifications.error('Errore Login', 'Errore durante il reindirizzamento');
    
    // Ripristina button
    if (loginBtn) {
      loginBtn.disabled = false;
    }
    if (loginButtonText) {
      loginButtonText.textContent = 'Accedi con Discord';
    }
  }
}

// Gestione risposta OAuth Discord
function handleDiscordCallback() {
  const fragment = window.location.hash.substring(1);
  const params = new URLSearchParams(fragment);
  const accessToken = params.get('access_token');
  const tokenType = params.get('token_type');
  const error = params.get('error');

  if (error) {
    console.error('❌ Errore OAuth:', error);
    notifications.error('Errore di autenticazione', `Discord ha restituito un errore: ${error}`);
    // Pulisci URL
    window.history.replaceState({}, document.title, window.location.pathname);
    return;
  }

  if (accessToken && tokenType) {
    console.log('✅ Token ricevuto, recupero informazioni utente...');
    fetchDiscordUser(accessToken, tokenType);
    // Pulisci URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

// Recupera informazioni utente Discord
async function fetchDiscordUser(accessToken, tokenType) {
  try {
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: {
        'Authorization': `${tokenType} ${accessToken}`,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const user = await response.json();
    console.log('👤 Utente Discord:', user);
    
    // Salva informazioni utente
    currentUser = {
      id: user.id,
      username: user.username,
      discriminator: user.discriminator,
      avatar: user.avatar,
      globalName: user.global_name || user.username
    };

    // Salva nel localStorage
    localStorage.setItem('discordUser', JSON.stringify(currentUser));
    localStorage.setItem('discordToken', accessToken);
    
    // Mostra dashboard
    showDashboard();
    
    notifications.success('Login riuscito!', `Benvenuto ${currentUser.globalName}!`);
    
  } catch (error) {
    console.error('❌ Errore nel recuperare l\'utente:', error);
    notifications.error('Errore Login', 'Non è stato possibile recuperare le informazioni dell\'utente');
  }
}

// Mostra dashboard
function showDashboard() {
  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  
  if (loginSection && dashboard) {
    loginSection.style.display = 'none';
    dashboard.style.display = 'block';
    
    // Aggiorna informazioni utente nell'header
    updateUserProfile();
  }
}

// Aggiorna profilo utente
function updateUserProfile() {
  if (!currentUser) return;

  const userName = document.getElementById('user-name');
  const userRole = document.getElementById('user-role');
  const userAvatar = document.getElementById('user-avatar-img');
  const userAvatarText = document.getElementById('user-avatar-text');

  if (userName) {
    userName.textContent = currentUser.globalName || currentUser.username;
  }
  
  if (userRole) {
    userRole.textContent = 'Operatore UOPI';
  }

  // Avatar
  if (currentUser.avatar && userAvatar && userAvatarText) {
    const avatarUrl = `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png?size=128`;
    userAvatar.src = avatarUrl;
    userAvatar.style.display = 'block';
    userAvatarText.style.display = 'none';
  } else if (userAvatarText) {
    userAvatarText.textContent = currentUser.globalName ? currentUser.globalName.charAt(0).toUpperCase() : '?';
  }
}

// Logout
function logout() {
  // Pulisci localStorage
  localStorage.removeItem('discordUser');
  localStorage.removeItem('discordToken');
  
  // Reset variabili
  currentUser = null;
  
  // Mostra sezione login
  const loginSection = document.getElementById('login-section');
  const dashboard = document.getElementById('dashboard');
  
  if (loginSection && dashboard) {
    loginSection.style.display = 'flex';
    dashboard.style.display = 'none';
  }
  
  notifications.info('Logout', 'Sei stato disconnesso con successo');
}

// Controlla se l'utente è già loggato
function checkExistingAuth() {
  const savedUser = localStorage.getItem('discordUser');
  const savedToken = localStorage.getItem('discordToken');
  
  if (savedUser && savedToken) {
    try {
      currentUser = JSON.parse(savedUser);
      console.log('✅ Utente trovato nel localStorage:', currentUser);
      showDashboard();
    } catch (error) {
      console.error('❌ Errore nel caricare l\'utente salvato:', error);
      localStorage.removeItem('discordUser');
      localStorage.removeItem('discordToken');
    }
  }
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Dashboard UOPI caricata');
  
  // Inizializza sistema notifiche
  notifications.init();
  
  // Controlla se è una risposta OAuth
  if (window.location.hash && window.location.hash.includes('access_token')) {
    handleDiscordCallback();
  } else {
    // Controlla se c'è un utente salvato
    checkExistingAuth();
  }
  
  // Log di benvenuto
  console.log('🎯 Sistema pronto per l\'uso');
  
  // Test notifica dopo 2 secondi se non loggato
  setTimeout(() => {
    if (!currentUser) {
      notifications.info('Dashboard UOPI', 'Benvenuto! Effettua il login per accedere al sistema.');
    }
  }, 2000);
});

// Gestione errori globali
window.addEventListener('error', function(e) {
  console.error('❌ Errore globale:', e.error);
  notifications.error('Errore di Sistema', 'Si è verificato un errore imprevisto');
});

// Service Worker per il caching (opzionale)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    // Implementazione service worker può essere aggiunta qui
  });
}
</script>

</body>
</html>
