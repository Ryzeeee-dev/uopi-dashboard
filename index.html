<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<style>
  *, *::before, *::after { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0;
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #eee;
    overflow-x: hidden;
  }

  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
  @keyframes slideInUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  /* üîÑ LOADING SCREEN */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-logo {
    font-size: 72px;
    margin-bottom: 30px;
    color: #4299e1;
    animation: pulse 2s infinite;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(66, 153, 225, 0.1);
    border-top: 4px solid #4299e1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  .loading-text {
    font-size: 18px;
    color: #a0aec0;
    text-align: center;
    margin-bottom: 20px;
  }

  /* üö´ ACCESS DENIED SCREEN MIGLIORATO */
  .access-denied-section {
    display: none;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
    position: relative;
    overflow: hidden;
  }

  .access-denied-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
    pointer-events: none;
  }

  .access-denied-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(220, 38, 38, 0.3);
    max-width: 600px;
    width: 90%;
    position: relative;
    z-index: 1;
    overflow: hidden;
    animation: slideInUp 0.6s ease-out;
  }

  .denied-background {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #dc2626, #ef4444, #f87171);
    box-shadow: 0 0 20px rgba(220, 38, 38, 0.5);
  }

  .denied-content {
    padding: 50px 40px 30px;
    text-align: center;
  }

  .denied-icon-container {
    position: relative;
    display: inline-block;
    margin-bottom: 30px;
  }

  .denied-icon {
    font-size: 120px;
    animation: pulse 3s infinite;
    text-shadow: 0 0 30px rgba(220, 38, 38, 0.5);
    position: relative;
    z-index: 2;
  }

  .denied-badge {
    position: absolute;
    top: -10px;
    right: -10px;
    background: linear-gradient(135deg, #1e293b, #334155);
    color: #3b82f6;
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 800;
    border: 2px solid #3b82f6;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    z-index: 3;
  }

  .denied-title {
    font-size: 36px;
    font-weight: 900;
    color: #dc2626;
    margin: 0 0 8px 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .denied-subtitle {
    font-size: 20px;
    font-weight: 600;
    color: #f1f5f9;
    margin: 0 0 25px 0;
    opacity: 0.9;
  }

  .denied-message {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 4px solid #dc2626;
  }

  .denied-message p {
    color: #cbd5e1;
    line-height: 1.6;
    margin: 0 0 12px 0;
    font-size: 16px;
  }

  .denied-message p:last-child {
    margin-bottom: 0;
  }

  .denied-info-card {
    background: linear-gradient(135deg, #1e293b, #334155);
    border-radius: 16px;
    margin-bottom: 30px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    overflow: hidden;
  }

  .info-header {
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    color: white;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .info-icon {
    font-size: 20px;
  }

  .info-content {
    padding: 20px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(59, 130, 246, 0.1);
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-label {
    color: #94a3b8;
    font-weight: 500;
    font-size: 14px;
  }

  .info-value {
    color: #f1f5f9;
    font-weight: 600;
    font-size: 14px;
    font-family: 'Courier New', monospace;
  }

  .denied-status {
    color: #ef4444 !important;
  }

  .denied-instructions {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: 16px;
    padding: 25px;
    margin-bottom: 30px;
    text-align: left;
  }

  .denied-instructions h3 {
    color: #10b981;
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 700;
    text-align: center;
  }

  .instruction-steps {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .step-number {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .step-text {
    color: #cbd5e1;
    font-size: 15px;
    line-height: 1.4;
  }

  .denied-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .retry-button, .info-button {
    border: none;
    padding: 16px 24px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 200px;
    justify-content: center;
  }

  .retry-button.primary {
    background: linear-gradient(135deg, #dc2626, #991b1b);
    color: white;
    box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4);
  }

  .retry-button.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(220, 38, 38, 0.6);
  }

  .info-button.secondary {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
    border: 1px solid rgba(59, 130, 246, 0.3);
  }

  .info-button.secondary:hover {
    background: rgba(59, 130, 246, 0.2);
    transform: translateY(-1px);
  }

  .btn-icon {
    font-size: 18px;
  }
</style>
</head>

<body>
<!-- üîÑ Loading Screen -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-logo">üöî</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Caricamento Dashboard UOPI...</div>
</div>

<!-- üö´ Access Denied Screen MIGLIORATO -->
<div id="access-denied-section" class="access-denied-section">
  <div class="access-denied-container">
    <!-- Background animato -->
    <div class="denied-background"></div>
    
    <!-- Contenuto principale -->
    <div class="denied-content">
      <div class="denied-icon-container">
        <div class="denied-icon">üö´</div>
        <div class="denied-badge">UOPI</div>
      </div>
      
      <h1 class="denied-title">Accesso Riservato</h1>
      <h2 class="denied-subtitle">Area Operatori UOPI Autorizzati</h2>
      
      <div class="denied-message">
        <p>Il tuo account Discord non risulta registrato nel sistema delle <strong>Unit√† Operative di Polizia Italiana</strong>.</p>
        <p>L'accesso a questa dashboard √® riservato esclusivamente agli operatori UOPI ufficialmente autorizzati.</p>
      </div>
      
      <div class="denied-info-card">
        <div class="info-header">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <strong>Informazioni Sistema</strong>
        </div>
        <div class="info-content">
          <div class="info-row">
            <span class="info-label">Discord ID:</span>
            <span class="info-value" id="denied-discord-id">N/A</span>
          </div>
          <div class="info-row">
            <span class="info-label">Stato Autorizzazione:</span>
            <span class="info-value denied-status">‚ùå Non Autorizzato</span>
          </div>
          <div class="info-row">
            <span class="info-label">Operatori Registrati:</span>
            <span class="info-value" id="denied-total-users">N/A</span>
          </div>
          <div class="info-row">
            <span class="info-label">Sistema:</span>
            <span class="info-value">üõ°Ô∏è Sicurezza Multi-Livello</span>
          </div>
        </div>
      </div>
      
      <div class="denied-instructions">
        <h3>üéØ Come Richiedere l'Accesso</h3>
        <div class="instruction-steps">
          <div class="step">
            <span class="step-number">1</span>
            <span class="step-text">Contatta la <strong>Dirigenza UOPI</strong> su Discord</span>
          </div>
          <div class="step">
            <span class="step-number">2</span>
            <span class="step-text">Fornisci il tuo <strong>Discord ID</strong> mostrato sopra</span>
          </div>
          <div class="step">
            <span class="step-number">3</span>
            <span class="step-text">Attendi l'autorizzazione della <strong>Dirigenza</strong></span>
          </div>
        </div>
      </div>
      
      <div class="denied-actions">
        <button class="retry-button primary" onclick="logout()">
          <span class="btn-icon">üîÑ</span>
          Riprova con Altro Account
        </button>
      </div>
    </div>
  </div>
</div>

<!-- üé® Login Section -->
<div id="login-section" class="login-section">
  <div class="login-container">
    <span class="login-logo">üöî</span>
    <h1 class="login-title">UOPI Dashboard</h1>
    <p class="login-subtitle">Sistema di Gestione Unit√† Operative<br>Accedi con il tuo account Discord autorizzato</p>
    
    <button id="discord-login-btn" class="discord-login-button">
      <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418Z"/>
      </svg>
      Accedi con Discord
    </button>
  </div>
</div>

<!-- üè† Main Dashboard -->
<div id="main-container" class="main-container">
  <h1 class="dashboard-title">üöî Dashboard UOPI</h1>
  
  <!-- User Header -->
  <div class="user-header">
    <div class="user-info-display">
      <div class="user-avatar" id="user-avatar">
        <span id="user-initial">?</span>
      </div>
      <div class="user-details">
        <h3 id="user-name-display">Operatore UOPI <span id="admin-badge" class="admin-badge" style="display: none;">DIRIGENZA</span></h3>
        <p id="user-role-display">üëÆ‚Äç‚ôÇÔ∏è Operatore</p>
        <p>Discord ID: <span id="user-id-display">N/A</span></p>
      </div>
    </div>
    <button class="logout-btn" onclick="logout()">üö™ Logout</button>
  </div>

  <!-- Quick Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number">15</div>
      <div class="stat-label">Operatori Attivi</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-number">8</div>
      <div class="stat-label">Interventi Attivi</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-number">4</div>
      <div class="stat-label">Squadre Operative</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-number">100%</div>
      <div class="stat-label">Sistema Attivo</div>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-tabs">
    <button class="nav-btn active" onclick="showSection('overview')">üìä Panoramica</button>
    <button class="nav-btn" onclick="showSection('operatori')">üëÆ‚Äç‚ôÇÔ∏è Operatori</button>
    <button class="nav-btn" onclick="showSection('interventi')">üö® Interventi</button>
    <button class="nav-btn" onclick="showSection('equipaggiamenti')">üõ°Ô∏è Equipaggiamenti</button>
    <button class="nav-btn" onclick="showSection('admin')" id="admin-tab" style="display: none;">‚öôÔ∏è Admin</button>
  </div>

  <!-- Dashboard Content -->
  <div class="dashboard-content">
    <div id="section-overview" class="dashboard-section">
      <div class="welcome-message">
        <h2 style="margin: 0 0 10px 0; font-size: 24px;">üéØ Benvenuto nel Sistema UOPI</h2>
        <p style="margin: 0; font-size: 16px; opacity: 0.9;">Dashboard operativa per la gestione delle Unit√† Operative di Polizia Italiana su FiveM</p>
      </div>
      
      <div class="feature-grid">
        <div class="feature-card">
          <h4><span>üëÆ‚Äç‚ôÇÔ∏è</span> Gestione Operatori</h4>
          <p>Sistema completo per la gestione degli operatori UOPI con controllo gerarchico e assegnazione ruoli.</p>
          <button class="feature-btn">Accedi al Modulo</button>
        </div>
        
        <div class="feature-card">
          <h4><span>üö®</span> Centro Interventi</h4>
          <p>Controllo centralizzato di tutti gli interventi in corso con assegnazione automatica squadre operative.</p>
          <button class="feature-btn">Centro Controllo</button>
        </div>
        
        <div class="feature-card">
          <h4><span>üõ°Ô∏è</span> Equipaggiamenti</h4>
          <p>Gestione completa dell'equipaggiamento UOPI con controllo inventario e manutenzione.</p>
          <button class="feature-btn">Gestisci Equipaggiamenti</button>
        </div>
        
        <div class="feature-card">
          <h4><span>üìä</span> Report e Statistiche</h4>
          <p>Analytics avanzate delle operazioni UOPI con report dettagliati e metriche performance.</p>
          <button class="feature-btn">Visualizza Report</button>
        </div>
      </div>
    </div>

    <div id="section-operatori" class="dashboard-section" style="display: none;">
      <h3 style="color: #f1f5f9; margin: 0 0 20px 0;">üëÆ‚Äç‚ôÇÔ∏è Gestione Operatori UOPI</h3>
      <p style="color: #94a3b8; margin: 0 0 20px 0;">Sistema per la gestione completa degli operatori con controllo gerarchico.</p>
      <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
        <p style="color: #64748b; margin: 0;">üîß Sezione in sviluppo - Funzionalit√† operative complete</p>
      </div>
    </div>

    <div id="section-interventi" class="dashboard-section" style="display: none;">
      <h3 style="color: #f1f5f9; margin: 0 0 20px 0;">üö® Centro Interventi UOPI</h3>
      <p style="color: #94a3b8; margin: 0 0 20px 0;">Controllo centralizzato degli interventi con assegnazione squadre.</p>
      <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
        <p style="color: #64748b; margin: 0;">üîß Sezione in sviluppo - Sistema interventi operativo</p>
      </div>
    </div>

    <div id="section-equipaggiamenti" class="dashboard-section" style="display: none;">
      <h3 style="color: #f1f5f9; margin: 0 0 20px 0;">üõ°Ô∏è Gestione Equipaggiamenti</h3>
      <p style="color: #94a3b8; margin: 0 0 20px 0;">Sistema completo per la gestione dell'equipaggiamento UOPI.</p>
      <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
        <p style="color: #64748b; margin: 0;">üîß Sezione in sviluppo - Inventario equipaggiamenti</p>
      </div>
    </div>

    <div id="section-admin" class="dashboard-section" style="display: none;">
      <h3 style="color: #dc2626; margin: 0 0 20px 0;">‚öôÔ∏è Pannello Amministrazione</h3>
      <div style="background: linear-gradient(135deg, #dc2626, #991b1b); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">
        <h4 style="margin: 0 0 10px 0;">üëë Controlli Dirigenza</h4>
        <p style="margin: 0; opacity: 0.9;">Accesso completo alle funzionalit√† amministrative del sistema UOPI.</p>
      </div>
      <div style="background: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 12px; text-align: center;">
        <p style="color: #64748b; margin: 0;">üîß Pannello admin completo - Funzionalit√† dirigenza</p>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div style="text-align: center; margin-top: 40px; padding: 20px; color: #64748b; font-size: 14px;">
    <p>üöî Dashboard UOPI - Sistema Multi-Utente Operativo</p>
    <p>‚úÖ Accesso per tutto il team UOPI - Sistema garantito</p>
  </div>
</div>

<script>
// üöî SISTEMA MULTI-UTENTE - TUTTI GLI OPERATORI UOPI
const CONFIG = {
  DISCORD: {
    CLIENT_ID: '1387801645743869982',
    REDIRECT_URI: 'https://ryze-glitch.github.io/uopi-dashboard/',
    SCOPE: 'identify'
  }
};

// üîë LISTA COMPLETA OPERATORI UOPI AUTORIZZATI
const AUTHORIZED_USERS = {
  // üëë DIRIGENZA GENERALE
  '817121576217870348': {
    nome: 'Tonino Frasca',
    ruolo: 'üëë Comandante Generale',
    admin: true
  },
  '1387684968536477756': {
    nome: 'Gabriel Martinelli',
    ruolo: 'üëë Comandante Generale',
    admin: true
  },
  '796078370176487454': {
    nome: 'Simone Sottaceto',
    ruolo: 'üí´ Comandante',
    admin: true
  },
  '814941325916241930': {
    nome: 'Matteo Rossi',
    ruolo: 'üåü Vice Comandante',
    admin: true
  },
  '1062981395644948550': {
    nome: 'Franco Costa',
    ruolo: 'üåü Vice Comandante',
    admin: true
  },
  '734406288213016607': {
    nome: 'Diego Bianchi',
    ruolo: '‚≠ê Sostituto Vice Comandante',
    admin: true
  },
  '1249738701081155658': {
    nome: 'Simone Brighella',
    ruolo: '‚≠ê Sostituto Vice Comandante',
    admin: true
  },
  // Nuovo ID aggiunto
  '1418191798198861824': {
    nome: 'Nuovo Operatore',
    ruolo: 'üëÆ‚Äç‚ôÇÔ∏è Operatore',
    admin: false
  },  
  // üèÖ DIRIGENZA DI REPARTO  
  '123456789012345678': {
    nome: 'Marco Alessis',
    ruolo: 'üèÖ Caposquadra',
    admin: false
  },
  
  // üëÆ‚Äç‚ôÇÔ∏è OPERATORI (Altri operatori)
  '234567890123456789': {
    nome: 'Luigi Romano',
    ruolo: 'üëÆ‚Äç‚ôÇÔ∏è Operatore Senior',
    admin: false
  },
  '345678901234567890': {
    nome: 'Antonio Verdi',
    ruolo: 'üëÆ‚Äç‚ôÇÔ∏è Operatore',
    admin: false
  }
};

// üîÑ Loading Manager
function showLoading(text = 'Caricamento Dashboard UOPI...') {
  const loading = document.getElementById('loading-overlay');
  const loadingText = loading.querySelector('.loading-text');
  loadingText.textContent = text;
  loading.classList.add('show');
}

function hideLoading() {
  setTimeout(() => {
    const loading = document.getElementById('loading-overlay');
    loading.classList.remove('show');
  }, 1000);
}

// ‚úÖ Controllo accesso MULTI-UTENTE
function checkAccess(discordUserID) {
  console.log('üîç Controllo accesso per ID:', discordUserID);
  console.log('üîë Totale utenti autorizzati:', Object.keys(AUTHORIZED_USERS).length);
  
  const user = AUTHORIZED_USERS[discordUserID];
  
  if (user) {
    console.log('‚úÖ ACCESSO AUTORIZZATO:', user);
    return {
      hasAccess: true,
      userData: user
    };
  } else {
    console.log('‚ùå ACCESSO NEGATO - ID non nella lista autorizzata');
    console.log('üìã Primi 5 ID autorizzati:', Object.keys(AUTHORIZED_USERS).slice(0, 5));
    return {
      hasAccess: false,
      userData: null
    };
  }
}

// üîê Discord OAuth
async function discordLogin() {
  try {
    console.log('üîê Avvio login Discord - Sistema Multi-Utente');
    
    const existingToken = getStoredToken();
    if (existingToken) {
      showLoading('Verifica sessione esistente...');
      const userData = await fetchUserData(existingToken);
      if (userData) {
        const accessResult = checkAccess(userData.id);
        if (accessResult.hasAccess) {
          showDashboard(userData, accessResult.userData);
          hideLoading();
        } else {
          showAccessDenied();
          hideLoading();
        }
        return;
      }
    }

    showLoading('Reindirizzamento a Discord...');

    const params = new URLSearchParams({
      client_id: CONFIG.DISCORD.CLIENT_ID,
      redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
      response_type: 'token',
      scope: CONFIG.DISCORD.SCOPE,
      prompt: 'consent'
    });

    window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
  } catch (error) {
    console.error('Login error:', error);
    hideLoading();
  }
}

async function handleCallback() {
  try {
    if (!window.location.hash) return;
    
    const fragment = new URLSearchParams(window.location.hash.slice(1));
    const token = fragment.get('access_token');
    
    if (!token) return;

    window.history.replaceState(null, null, window.location.pathname);
    
    showLoading('Verifica credenziali Discord...');
    
    const userData = await fetchUserData(token);
    if (!userData) throw new Error('Dati utente Discord non validi');

    console.log('üë§ Dati Discord ricevuti:', userData);
    
    // ‚úÖ CONTROLLO MULTI-UTENTE
    const accessResult = checkAccess(userData.id);
    
    if (!accessResult.hasAccess) {
      showAccessDenied();
      hideLoading();
      return;
    }

    saveSession(token, userData);
    
    console.log(`‚úÖ Accesso autorizzato per ${userData.username} (${userData.id})`);
    
    setTimeout(() => {
      showDashboard(userData, accessResult.userData);
      hideLoading();
    }, 1000);
    
  } catch (error) {
    console.error('Callback error:', error);
    hideLoading();
    logout();
  }
}

async function fetchUserData(token) {
  try {
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (!response.ok) throw new Error('Discord API error');
    return response.json();
  } catch (error) {
    console.error('Fetch user data error:', error);
    return null;
  }
}

function saveSession(token, userData) {
  localStorage.setItem('discord_token', token);
  localStorage.setItem('user_data', JSON.stringify(userData));
  localStorage.setItem('login_timestamp', Date.now().toString());
}

function getStoredToken() {
  const token = localStorage.getItem('discord_token');
  const timestamp = localStorage.getItem('login_timestamp');
  
  if (token && timestamp) {
    const now = Date.now();
    const loginTime = parseInt(timestamp);
    const sevenDays = 7 * 24 * 60 * 60 * 1000;
    
    if (now - loginTime < sevenDays) {
      return token;
    }
  }
  
  return null;
}

function logout() {
  localStorage.clear();
  window.location.reload();
}

// üé® UI Functions
function showDashboard(discordUserData, systemUserData) {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('access-denied-section').style.display = 'none';
  document.getElementById('main-container').style.display = 'block';
  
  // Aggiorna le informazioni utente
  const userName = systemUserData?.nome || discordUserData.username || 'Operatore UOPI';
  const userRole = systemUserData?.ruolo || 'üëÆ‚Äç‚ôÇÔ∏è Operatore';
  const isAdmin = systemUserData?.admin || false;
  
  document.getElementById('user-name-display').innerHTML = userName + (isAdmin ? '<span id="admin-badge" class="admin-badge">DIRIGENZA</span>' : '');
  document.getElementById('user-role-display').textContent = userRole;
  document.getElementById('user-id-display').textContent = discordUserData.id;
  document.getElementById('user-initial').textContent = userName.charAt(0).toUpperCase();
  
  // Mostra avatar se disponibile
  if (discordUserData.avatar) {
    const avatarUrl = `https://cdn.discordapp.com/avatars/${discordUserData.id}/${discordUserData.avatar}.png?size=128`;
    document.getElementById('user-avatar').innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
  }
  
  // Mostra tab admin se √® dirigenza
  if (isAdmin) {
    document.getElementById('admin-tab').style.display = 'block';
    document.getElementById('user-avatar').classList.add('admin');
  }
  
  console.log('‚úÖ Dashboard caricata per:', userName, '- Admin:', isAdmin);
}

function showSection(sectionName) {
  // Nascondi tutte le sezioni
  const sections = document.querySelectorAll('.dashboard-section');
  sections.forEach(section => section.style.display = 'none');
  
  // Rimuovi active da tutti i bottoni
  const buttons = document.querySelectorAll('.nav-btn');
  buttons.forEach(btn => btn.classList.remove('active'));
  
  // Mostra la sezione selezionata
  document.getElementById('section-' + sectionName).style.display = 'block';
  
  // Attiva il bottone corrispondente
  event.target.classList.add('active');
}

async function checkExistingSession() {
  const token = getStoredToken();
  const userData = JSON.parse(localStorage.getItem('user_data') || 'null');
  
  if (token && userData) {
    showLoading('Controllo sessione salvata...');
    const freshUserData = await fetchUserData(token);
    if (freshUserData) {
      const accessResult = checkAccess(freshUserData.id);
      if (accessResult.hasAccess) {
        setTimeout(() => {
          showDashboard(userData, accessResult.userData);
          hideLoading();
        }, 1000);
        return true;
      } else {
        showAccessDenied();
        hideLoading();
        return true;
      }
    }
  }
  return false;
}

// üöÄ Inizializzazione MULTI-UTENTE
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöî === INIZIALIZZAZIONE DASHBOARD UOPI MULTI-UTENTE ===');
  console.log('üîë Utenti autorizzati:', Object.keys(AUTHORIZED_USERS).length);
  console.log('üëë Dirigenza:', Object.values(AUTHORIZED_USERS).filter(u => u.admin).length);
  console.log('üëÆ‚Äç‚ôÇÔ∏è Operatori:', Object.values(AUTHORIZED_USERS).filter(u => !u.admin).length);
  console.log('üõ°Ô∏è Sistema: Multi-Utente con autenticazione Discord');
  
  if (window.location.hash && window.location.hash.includes('access_token')) {
    console.log('üîÑ Gestione callback Discord OAuth...');
    await handleCallback();
    return;
  }
  
  const hasExistingSession = await checkExistingSession();
  
  if (!hasExistingSession) {
    // ‚úÖ EVENT LISTENER LOGIN BUTTON
    const discordBtn = document.getElementById('discord-login-btn');
    if (discordBtn) {
      discordBtn.addEventListener('click', function() {
        console.log('üîê Login avviato - Sistema Multi-Utente');
        this.disabled = true;
        this.innerHTML = `
          <div style="width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;display:inline-block;margin-right:10px;"></div>
          Accesso in corso...
        `;
        discordLogin();
      });
      console.log('‚úÖ Event listener configurato - Sistema Multi-Utente attivo');
    }
  }
  
  console.log('üöî === INIZIALIZZAZIONE COMPLETATA ===');
  console.log('üî• DASHBOARD MULTI-UTENTE OPERATIVA - TUTTO IL TEAM UOPI PU√í ACCEDERE!');
});
</script>

</body>
</html>
