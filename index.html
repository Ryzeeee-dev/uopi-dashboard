<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Gestione UOPI - FiveM</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://discord.com https://discordapp.com https://cdn.discordapp.com https://*.discord.com https://script.google.com https://script.googleusercontent.com; connect-src 'self' https://discord.com https://discordapp.com https://api.discord.com https://script.google.com https://script.googleusercontent.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<style>
  *, *::before, *::after { 
    box-sizing: border-box; 
    margin: 0; 
    padding: 0;
  }
  
  html, body {
    height: 100%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #eee;
    overflow-x: hidden;
  }

  /* ‚ú® ANIMAZIONI */
  @keyframes slideInUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes progress {
    0% { width: 0%; }
    100% { width: 100%; }
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  @keyframes glow {
    0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
    50% { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
  }

  /* üîÑ LOADING SCREEN */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #1a202c 100%);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    opacity: 1;
    transition: opacity 0.5s ease-out;
  }

  .loading-overlay.show {
    display: flex;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-logo {
    font-size: 72px;
    margin-bottom: 30px;
    color: #4299e1;
    animation: pulse 2s infinite;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(66, 153, 225, 0.1);
    border-top: 4px solid #4299e1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  .loading-text {
    font-size: 18px;
    color: #a0aec0;
    margin-bottom: 30px;
    text-align: center;
    font-weight: 500;
  }

  .loading-debug {
    font-size: 12px;
    color: #64748b;
    margin-bottom: 20px;
    text-align: center;
    font-family: 'Courier New', monospace;
    max-width: 400px;
  }

  .loading-progress {
    width: 350px;
    height: 8px;
    background: rgba(66, 153, 225, 0.1);
    border-radius: 4px;
    overflow: hidden;
  }

  .loading-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4299e1, #667eea, #8b5cf6);
    border-radius: 4px;
    width: 0%;
    animation: progress 4s ease-out forwards;
  }

  /* üö´ ACCESS DENIED SCREEN */
  .access-denied-section {
    display: none;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
  }

  .access-denied-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(220, 38, 38, 0.3);
    max-width: 500px;
    width: 90%;
    text-align: center;
  }

  .access-denied-icon {
    font-size: 100px;
    color: #dc2626;
    margin-bottom: 20px;
    animation: pulse 3s infinite;
  }

  .access-denied-title {
    font-size: 32px;
    font-weight: 800;
    color: #dc2626;
    margin: 0 0 16px 0;
  }

  .access-denied-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 20px 0;
    line-height: 1.6;
  }

  .debug-info {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    font-family: 'Courier New', monospace;
    font-size: 12px;
    color: #94a3b8;
    text-align: left;
    max-height: 150px;
    overflow-y: auto;
  }

  .retry-button {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: none;
    padding: 18px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .retry-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(220, 38, 38, 0.6);
  }

  /* üé® LOGIN SECTION */
  .login-section {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .login-container {
    background: rgba(26, 32, 44, 0.95);
    backdrop-filter: blur(25px);
    border-radius: 24px;
    padding: 60px 50px;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
    max-width: 480px;
    width: 90%;
    text-align: center;
  }

  .login-logo {
    font-size: 72px;
    margin-bottom: 20px;
    display: block;
    animation: glow 3s infinite;
  }

  .login-title {
    font-size: 36px;
    font-weight: 800;
    color: #ffffff;
    margin: 0 0 12px 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .login-subtitle {
    font-size: 16px;
    color: #cbd5e1;
    margin: 0 0 40px 0;
    line-height: 1.6;
  }

  .discord-login-button {
    background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
    color: white;
    border: none;
    padding: 20px 36px;
    border-radius: 16px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    box-shadow: 0 8px 30px rgba(88, 101, 242, 0.4);
    transition: all 0.3s ease;
  }

  .discord-login-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(88, 101, 242, 0.5);
  }

  .discord-login-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .discord-icon {
    width: 24px;
    height: 24px;
    flex-shrink: 0;
  }

  .error-message, .success-message {
    padding: 15px 20px;
    border-radius: 12px;
    margin: 20px 0;
    display: none;
    font-weight: 500;
  }

  .error-message {
    background: linear-gradient(135deg, #fed7d7, #feb2b2);
    color: #9b2c2c;
    border-left: 4px solid #e53e3e;
  }

  .success-message {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
    color: #065f46;
    border-left: 4px solid #10b981;
  }

  /* üè† MAIN DASHBOARD - Semplificato per test */
  .main-container {
    display: none;
    min-height: 100vh;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    padding: 50px 30px;
    text-align: center;
  }

  .dashboard-title {
    font-size: 48px;
    font-weight: 900;
    color: #f1f5f9;
    margin-bottom: 30px;
    background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .user-info-card {
    background: rgba(26, 32, 44, 0.95);
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    margin: 0 auto 30px;
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .logout-btn {
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
  }

  .logout-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(220, 38, 38, 0.4);
  }

  /* üì± RESPONSIVE */
  @media (max-width: 768px) {
    .login-container, .access-denied-container {
      padding: 40px 30px;
      margin: 20px;
    }
    
    .main-container {
      padding: 25px 15px;
    }
    
    .dashboard-title {
      font-size: 36px;
    }
  }
</style>
</head>

<body>
<!-- üîÑ Loading Screen -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loading-logo">üöî</div>
  <div class="loading-spinner"></div>
  <div class="loading-text">Caricamento Dashboard UOPI...</div>
  <div id="loading-debug" class="loading-debug">Inizializzazione sistema...</div>
  <div class="loading-progress">
    <div class="loading-progress-bar"></div>
  </div>
</div>

<!-- üö´ Access Denied Screen -->
<div id="access-denied-section" class="access-denied-section">
  <div class="access-denied-container">
    <div class="access-denied-icon">üö´</div>
    <h1 class="access-denied-title">Accesso Negato</h1>
    <p class="access-denied-subtitle">Il tuo account Discord non √® autorizzato ad accedere a questa dashboard UOPI.</p>
    <div id="debug-info" class="debug-info">
      Debug info verr√† caricato qui...
    </div>
    <button class="retry-button" onclick="DiscordAuth.logout()">
      üîÑ Riprova con altro account
    </button>
  </div>
</div>

<!-- üé® Login Section -->
<div id="login-section" class="login-section">
  <div class="login-container">
    <span class="login-logo">üöî</span>
    <h1 class="login-title">UOPI Dashboard</h1>
    <p class="login-subtitle">Sistema di Gestione Unit√† Operative<br>Accedi con il tuo account Discord autorizzato</p>
    
    <button id="discord-login-btn" class="discord-login-button">
      <svg class="discord-icon" viewBox="0 0 24 24" fill="currentColor">
        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.010c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418Z"/>
      </svg>
      Accedi con Discord
    </button>
    
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>
  </div>
</div>

<!-- üè† Main Dashboard -->
<div id="main-container" class="main-container">
  <h1 class="dashboard-title">üöî Dashboard UOPI</h1>
  
  <div class="user-info-card">
    <h2>Benvenuto nella Dashboard UOPI</h2>
    <div id="user-details">
      <p><strong>Nome:</strong> <span id="user-name-display">Caricamento...</span></p>
      <p><strong>Ruolo:</strong> <span id="user-role-display">Caricamento...</span></p>
      <p><strong>Discord ID:</strong> <span id="user-id-display">Caricamento...</span></p>
      <p><strong>Livello:</strong> <span id="user-admin-display">Caricamento...</span></p>
      <p><strong>Fonte dati:</strong> <span id="data-source-display">Caricamento...</span></p>
    </div>
    
    <button class="logout-btn" onclick="DiscordAuth.logout()">
      üö™ Esci dalla Dashboard
    </button>
  </div>
  
  <div style="margin-top: 30px; color: #64748b; font-size: 14px;">
    <p>‚úÖ Sistema con lettura automatica foglio Google Sheets + fallback garantito</p>
    <p>üîë Il tuo accesso √® sempre assicurato dalla lista hardcoded</p>
  </div>
</div>

<script>
// üöî CONFIGURAZIONE SISTEMA DEFINITIVO
const CONFIG = {
  DISCORD: {
    CLIENT_ID: '1387801645743869982',
    REDIRECT_URI: 'https://ryze-glitch.github.io/uopi-dashboard/',
    SCOPE: 'identify'
  },
  // üìã GOOGLE APPS SCRIPT API - LETTURA FOGLIO + FALLBACK
  API: {
    URL: 'https://script.google.com/macros/s/AKfycbzcTGSXyzxY5SRwnM6paqNHwhY4UqZM1Xy1pjUpS7_r/exec'
  }
};

// üîÑ Loading Manager con Debug
class LoadingManager {
  static show(text = 'Caricamento Dashboard UOPI...') {
    const loading = document.getElementById('loading-overlay');
    const loadingText = loading.querySelector('.loading-text');
    loadingText.textContent = text;
    loading.classList.add('show');
  }
  
  static hide() {
    setTimeout(() => {
      const loading = document.getElementById('loading-overlay');
      loading.classList.add('hidden');
      setTimeout(() => {
        loading.classList.remove('show', 'hidden');
      }, 500);
    }, 1200);
  }
  
  static updateText(text) {
    const loadingText = document.querySelector('.loading-text');
    if (loadingText) loadingText.textContent = text;
  }
  
  static updateDebug(debug) {
    const debugEl = document.getElementById('loading-debug');
    if (debugEl) debugEl.textContent = debug;
  }
}

// üìã Access Control - SISTEMA COMPLETO
class AccessControl {
  static async fetchUserData() {
    try {
      console.log('üîç Connessione a Google Apps Script (lettura foglio + fallback)...');
      LoadingManager.updateText('Connessione al sistema autorizzazioni...');
      LoadingManager.updateDebug('Tentativo connessione Google Apps Script...');
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 20000);
      
      const response = await fetch(CONFIG.API.URL, {
        method: 'GET',
        headers: {
          'Accept': 'application/json',
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache'
        },
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Errore API');
      }
      
      console.log(`‚úÖ Sistema ${data.debug.source} - ${data.count} utenti autorizzati`);
      console.log('üéØ Il tuo ID incluso:', data.debug.yourIdIncluded ? '‚úÖ S√å' : '‚ùå NO');
      console.log('üë§ Il tuo profilo:', data.debug.yourUser);
      
      LoadingManager.updateText(`Sistema ${data.debug.source} attivo`);
      LoadingManager.updateDebug(`${data.debug.source}: ${data.count} utenti, il tuo ID: ${data.debug.yourIdIncluded ? 'INCLUSO' : 'MANCANTE'}`);
      
      return data;
      
    } catch (error) {
      console.error('‚ùå Errore Google Apps Script:', error);
      LoadingManager.updateText('Errore connessione - Sistema offline');
      LoadingManager.updateDebug(`Errore: ${error.message}`);
      throw error;
    }
  }
  
  static async checkUserAccess(discordUserID) {
    try {
      LoadingManager.updateText('Verifica autorizzazioni...');
      LoadingManager.updateDebug(`Controllo ID: ${discordUserID}`);
      
      const data = await this.fetchUserData();
      
      console.log('üîç Verifica accesso per Discord ID:', discordUserID);
      
      // ‚úÖ CONTROLLO NELLA LISTA
      const isAuthorized = data.allowedUsers && data.allowedUsers.includes(discordUserID);
      
      let userDetails = null;
      if (isAuthorized && data.users) {
        userDetails = data.users.find(user => user.id === discordUserID || user.discordId === discordUserID);
      }
      
      // Log dettagliato per debug
      const debugInfo = {
        discordId: discordUserID,
        authorized: isAuthorized,
        source: data.debug?.source,
        totalUsers: data.count,
        userDetails: userDetails,
        allIds: data.allowedUsers?.slice(0, 10)
      };
      
      console.log('üìä Debug completo accesso:', debugInfo);
      
      if (isAuthorized) {
        console.log(`‚úÖ ACCESSO AUTORIZZATO per ${discordUserID}`);
        
        const finalUserData = userDetails || { 
          id: discordUserID, 
          nome: 'Operatore UOPI', 
          ruolo: 'Operatore UOPI', 
          admin: true
        };
        
        return {
          hasAccess: true,
          userData: finalUserData,
          source: data.debug?.source,
          debugInfo: debugInfo
        };
      } else {
        console.log(`‚ùå ACCESSO NEGATO per ${discordUserID}`);
        return {
          hasAccess: false,
          userData: null,
          source: data.debug?.source,
          debugInfo: debugInfo
        };
      }
      
    } catch (error) {
      console.error('‚ùå Errore controllo accessi:', error);
      LoadingManager.hide();
      
      const debugInfo = {
        discordId: discordUserID,
        error: error.message,
        authorized: false
      };
      
      return {
        hasAccess: false,
        userData: null,
        error: error.message,
        debugInfo: debugInfo
      };
    }
  }
}

// üîê Discord OAuth - SISTEMA CON DEBUG
class DiscordAuth {
  static async login() {
    try {
      console.log('üîê Avvio login Discord con debug completo...');
      
      const existingToken = this.getStoredToken();
      if (existingToken) {
        LoadingManager.show('Verifica sessione esistente...');
        const userData = await this.fetchUserData(existingToken);
        if (userData) {
          const accessResult = await AccessControl.checkUserAccess(userData.id);
          if (accessResult.hasAccess) {
            LoadingManager.updateText('Sessione valida - Accesso confermato');
            setTimeout(() => {
              UI.showDashboard(userData, accessResult.userData, accessResult.source, accessResult.debugInfo);
              LoadingManager.hide();
            }, 1000);
          } else {
            LoadingManager.hide();
            UI.showAccessDenied(accessResult.debugInfo);
          }
          return;
        }
      }

      LoadingManager.show('Avvio autenticazione Discord...');

      const params = new URLSearchParams({
        client_id: CONFIG.DISCORD.CLIENT_ID,
        redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
        response_type: 'token',
        scope: CONFIG.DISCORD.SCOPE,
        prompt: 'consent'
      });

      window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
    } catch (error) {
      console.error('Login error:', error);
      LoadingManager.hide();
      UI.showError('Errore durante il login: ' + error.message);
    }
  }

  static async handleCallback() {
    try {
      if (!window.location.hash) return;
      
      const fragment = new URLSearchParams(window.location.hash.slice(1));
      const token = fragment.get('access_token');
      const error = fragment.get('error');
      
      if (error === 'access_denied') {
        LoadingManager.show('Reindirizzamento autorizzazione...');
        const params = new URLSearchParams({
          client_id: CONFIG.DISCORD.CLIENT_ID,
          redirect_uri: CONFIG.DISCORD.REDIRECT_URI,
          response_type: 'token',
          scope: CONFIG.DISCORD.SCOPE,
          prompt: 'consent'
        });
        window.location.href = `https://discord.com/api/oauth2/authorize?${params}`;
        return;
      }
      
      if (!token) return;

      window.history.replaceState(null, null, window.location.pathname);
      
      LoadingManager.show('Verifica credenziali Discord...');
      
      const userData = await this.fetchUserData(token);
      if (!userData) throw new Error('Dati utente Discord non validi');

      LoadingManager.updateText('Controllo autorizzazioni sistema...');
      
      // üîç CONTROLLO ACCESSO CON DEBUG COMPLETO
      const accessResult = await AccessControl.checkUserAccess(userData.id);
      
      if (!accessResult.hasAccess) {
        LoadingManager.hide();
        UI.showAccessDenied(accessResult.debugInfo);
        console.log(`‚ùå Accesso negato per ${userData.username} (${userData.id})`);
        return;
      }

      this.saveSession(token, userData);
      
      console.log(`‚úÖ Accesso autorizzato per ${userData.username} (${userData.id})`);
      LoadingManager.updateText('Accesso confermato - Caricamento dashboard...');
      
      setTimeout(() => {
        UI.showDashboard(userData, accessResult.userData, accessResult.source, accessResult.debugInfo);
        LoadingManager.hide();
      }, 1500);
      
    } catch (error) {
      console.error('Callback error:', error);
      LoadingManager.hide();
      UI.showError('Errore di autenticazione: ' + error.message);
      this.logout();
    }
  }

  static async fetchUserData(token) {
    try {
      const response = await fetch('https://discord.com/api/users/@me', {
        headers: { Authorization: `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('Discord API error');
      return response.json();
    } catch (error) {
      console.error('Fetch user data error:', error);
      return null;
    }
  }

  static saveSession(token, userData) {
    localStorage.setItem('discord_token', token);
    localStorage.setItem('user_data', JSON.stringify(userData));
    localStorage.setItem('login_timestamp', Date.now().toString());
  }

  static getStoredToken() {
    const token = localStorage.getItem('discord_token');
    const timestamp = localStorage.getItem('login_timestamp');
    
    if (token && timestamp) {
      const now = Date.now();
      const loginTime = parseInt(timestamp);
      const sevenDays = 7 * 24 * 60 * 60 * 1000;
      
      if (now - loginTime < sevenDays) {
        return token;
      }
    }
    
    return null;
  }

  static getStoredUserData() {
    const userData = localStorage.getItem('user_data');
    return userData ? JSON.parse(userData) : null;
  }

  static logout() {
    localStorage.clear();
    window.location.reload();
  }

  static async checkExistingSession() {
    const token = this.getStoredToken();
    const userData = this.getStoredUserData();
    
    if (token && userData) {
      LoadingManager.show('Controllo sessione salvata...');
      const freshUserData = await this.fetchUserData(token);
      if (freshUserData) {
        const accessResult = await AccessControl.checkUserAccess(freshUserData.id);
        if (accessResult.hasAccess) {
          LoadingManager.updateText('Sessione valida - Ripristino...');
          setTimeout(() => {
            UI.showDashboard(userData, accessResult.userData, accessResult.source, accessResult.debugInfo);
            LoadingManager.hide();
          }, 1000);
          return true;
        } else {
          UI.showAccessDenied(accessResult.debugInfo);
          return true;
        }
      }
    }
    return false;
  }
}

// üé® UI Management - CON DEBUG
class UI {
  static showDashboard(discordUserData, systemUserData, source, debugInfo) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('access-denied-section').style.display = 'none';
    document.getElementById('main-container').style.display = 'block';
    
    // Aggiorna le informazioni utente
    document.getElementById('user-name-display').textContent = systemUserData?.nome || discordUserData.username || 'N/A';
    document.getElementById('user-role-display').textContent = systemUserData?.ruolo || 'Operatore UOPI';
    document.getElementById('user-id-display').textContent = discordUserData.id;
    document.getElementById('user-admin-display').textContent = systemUserData?.admin ? 'üëë Dirigenza' : 'üëÆ‚Äç‚ôÇÔ∏è Operatore';
    document.getElementById('data-source-display').textContent = source || 'N/A';
    
    console.log('‚úÖ Dashboard caricata con successo');
  }

  static showAccessDenied(debugInfo) {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('main-container').style.display = 'none';
    document.getElementById('access-denied-section').style.display = 'flex';
    
    // Mostra info di debug
    if (debugInfo) {
      const debugEl = document.getElementById('debug-info');
      debugEl.innerHTML = `
        <strong>Debug Info:</strong><br>
        Discord ID: ${debugInfo.discordId}<br>
        Autorizzato: ${debugInfo.authorized ? '‚úÖ' : '‚ùå'}<br>
        Fonte dati: ${debugInfo.source || 'N/A'}<br>
        Totale utenti: ${debugInfo.totalUsers || 'N/A'}<br>
        ${debugInfo.error ? `Errore: ${debugInfo.error}<br>` : ''}
        Primi 5 ID autorizzati: ${debugInfo.allIds ? debugInfo.allIds.join(', ') : 'N/A'}
      `;
    }
  }

  static showError(message) {
    const errorEl = document.getElementById('error-message');
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 8000);
    }
  }
  
  static showSuccess(message) {
    const successEl = document.getElementById('success-message');
    if (successEl) {
      successEl.textContent = message;
      successEl.style.display = 'block';
      setTimeout(() => successEl.style.display = 'none', 8000);
    }
  }
}

// üöÄ Initialize - SISTEMA COMPLETO CON DEBUG
document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöî === INIZIALIZZAZIONE DASHBOARD UOPI SISTEMA COMPLETO ===');
  console.log('üìã Google Apps Script:', CONFIG.API.URL);
  console.log('üîê Discord Client:', CONFIG.DISCORD.CLIENT_ID);
  console.log('üõ°Ô∏è Sistema: Lettura foglio + Nome utente + Fallback garantito');
  console.log('üéØ Target ID: 817121576217870348 (sempre incluso nel fallback)');
  
  if (window.location.hash && window.location.hash.includes('access_token')) {
    console.log('üîÑ Gestione callback Discord OAuth...');
    await DiscordAuth.handleCallback();
    return;
  }
  
  const hasExistingSession = await DiscordAuth.checkExistingSession();
  
  if (!hasExistingSession) {
    // ‚úÖ EVENT LISTENER LOGIN BUTTON
    const discordBtn = document.getElementById('discord-login-btn');
    if (discordBtn) {
      discordBtn.addEventListener('click', function() {
        console.log('üîê Login avviato - Sistema completo attivo');
        this.disabled = true;
        this.innerHTML = `
          <div style="width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;display:inline-block;margin-right:10px;"></div>
          Autenticazione in corso...
        `;
        DiscordAuth.login();
      });
      console.log('‚úÖ Event listener login configurato');
    }
  }
  
  console.log('üöî === INIZIALIZZAZIONE COMPLETATA ===');
  console.log('üî• SISTEMA DEFINITIVO - LETTURA FOGLIO + FALLBACK ASSOLUTO');
});
</script>

</body>
</html>
